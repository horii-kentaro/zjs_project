# 脆弱性一覧ページ API仕様書

生成日: 2026-01-07
収集元: src/api/vulnerabilities.py, src/services/mock_vulnerability_service.py
@MOCK_TO_APIマーク数: 9

---

## エンドポイント一覧

### 1. 脆弱性一覧取得（JSON API）
- **エンドポイント**: `GET /api/vulnerabilities`
- **説明**: 脆弱性一覧を取得（検索、ソート、ページネーション対応）
- **認証**: 不要（公開API）

#### クエリパラメータ
```yaml
page:
  type: integer
  default: 1
  description: ページ番号

page_size:
  type: integer
  default: 50
  description: 1ページあたりの件数（最大100）

search:
  type: string
  optional: true
  description: 検索キーワード（CVE IDまたはタイトルで部分一致）

sort_by:
  type: string
  enum: [published_date, modified_date, severity, cvss_score]
  default: modified_date
  description: ソート基準

sort_order:
  type: string
  enum: [asc, desc]
  default: desc
  description: ソート順序
```

#### Request例
```bash
# 基本的な取得
GET /api/vulnerabilities?page=1&page_size=50

# 検索（CVE IDまたはタイトル）
GET /api/vulnerabilities?search=Apache&page=1

# ソート（重要度降順）
GET /api/vulnerabilities?sort_by=severity&sort_order=desc

# 複合条件
GET /api/vulnerabilities?search=OpenSSL&sort_by=published_date&sort_order=desc&page=1&page_size=20
```

#### Response
```typescript
{
  items: Vulnerability[];           // 脆弱性リスト
  total: number;                    // 総件数
  page: number;                     // 現在のページ番号
  page_size: number;                // 1ページあたりの件数
  total_pages: number;              // 総ページ数
}

interface Vulnerability {
  cve_id: string;                   // CVE ID（例: CVE-2024-0001）
  title: string;                    // タイトル
  description: string;              // 概要
  cvss_score: number | null;        // CVSS基本値（0.0〜10.0）
  severity: string | null;          // 重要度（Critical/High/Medium/Low）
  published_date: string;           // 公開日（ISO 8601）
  modified_date: string;            // 更新日（ISO 8601）
  affected_products: string[] | null;  // 影響を受ける製品
  vendor_info: string[] | null;     // ベンダー情報
  references: {
    jvn_url?: string;               // JVN iPedia URL
    nvd_url?: string;               // NVD URL
    cwe_id?: string;                // CWE ID
  } | null;
  created_at: string;               // DB登録日時
  updated_at: string;               // DB更新日時
}
```

#### エラーレスポンス
```yaml
400 Bad Request:
  - page_sizeが100を超える場合
  - sort_byが不正な値の場合

500 Internal Server Error:
  - データベース接続エラー
  - 予期しないサーバーエラー
```

---

### 2. 脆弱性詳細取得（モーダル用）
- **エンドポイント**: `GET /api/vulnerabilities/{cve_id}`
- **説明**: 指定されたCVE IDの詳細情報を取得
- **認証**: 不要（公開API）

#### パスパラメータ
```yaml
cve_id:
  type: string
  pattern: CVE-\d{4}-\d{4,}
  description: CVE ID（例: CVE-2024-0001）
```

#### Request例
```bash
GET /api/vulnerabilities/CVE-2024-0001
```

#### Response
```typescript
{
  cve_id: string;
  title: string;
  description: string;              // 詳細な説明
  cvss_score: number | null;
  severity: string | null;
  published_date: string;
  modified_date: string;
  affected_products: string[] | null;
  vendor_info: string[] | null;
  references: {
    jvn_url?: string;
    nvd_url?: string;
    cwe_id?: string;
  } | null;
  created_at: string;
  updated_at: string;
}
```

#### エラーレスポンス
```yaml
404 Not Found:
  - 指定されたCVE IDが存在しない場合

500 Internal Server Error:
  - データベース接続エラー
  - 予期しないサーバーエラー
```

---

### 3. ヘルスチェック
- **エンドポイント**: `GET /api/health`
- **説明**: システムの健全性を確認
- **認証**: 不要（公開API）

#### Response
```typescript
{
  status: string;                   // "healthy" or "unhealthy"
  database: string;                 // "connected" or "disconnected"
  timestamp: string;                // ISO 8601形式
}
```

#### Phase 5での拡張予定
```typescript
// データベース接続確認を追加
{
  status: "healthy",
  database: "connected",
  database_url: "postgresql://***", // マスク済み
  timestamp: "2026-01-07T12:00:00Z"
}
```

---

## @MOCK_TO_API マーク一覧

### src/api/vulnerabilities.py

#### 1. list_vulnerabilities関数（88行目）
```python
# @MOCK_TO_API: Replace with database service
mock_service = MockVulnerabilityService()
result = mock_service.search_vulnerabilities(...)
```

**Phase 5での実装**:
```python
# データベースサービスに置き換え
db_service = DatabaseVulnerabilityService(db)
result = db_service.search_vulnerabilities(
    search=search,
    sort_by=sort_by,
    sort_order=sort_order,
    page=page,
    page_size=page_size
)
```

#### 2. get_vulnerability_detail関数（134行目）
```python
# @MOCK_TO_API: Replace with database service
mock_service = MockVulnerabilityService()
vulnerability = mock_service.get_vulnerability_by_cve_id(cve_id)
```

**Phase 5での実装**:
```python
# データベースクエリに置き換え
vulnerability = db.query(Vulnerability)\
    .filter(Vulnerability.cve_id == cve_id)\
    .first()
if not vulnerability:
    raise HTTPException(status_code=404, detail='Vulnerability not found')
```

---

### src/services/mock_vulnerability_service.py

#### 3. クラス全体（13行目）
```python
# @MOCK_TO_API: This entire class will be replaced with actual database
class MockVulnerabilityService:
    ...
```

**Phase 5での実装**:
```python
class DatabaseVulnerabilityService:
    def __init__(self, db: Session):
        self.db = db

    def search_vulnerabilities(self, ...) -> VulnerabilityListResponse:
        # SQLAlchemyクエリで実装
        query = self.db.query(Vulnerability)

        # 検索条件
        if search:
            query = query.filter(
                or_(
                    Vulnerability.cve_id.ilike(f'%{search}%'),
                    Vulnerability.title.ilike(f'%{search}%')
                )
            )

        # ソート
        if sort_by == 'severity':
            # 重要度の順序定義
            severity_order = case(
                (Vulnerability.severity == 'Critical', 1),
                (Vulnerability.severity == 'High', 2),
                (Vulnerability.severity == 'Medium', 3),
                (Vulnerability.severity == 'Low', 4),
                else_=5
            )
            query = query.order_by(
                severity_order.desc() if sort_order == 'desc' else severity_order
            )
        else:
            order_column = getattr(Vulnerability, sort_by)
            query = query.order_by(
                order_column.desc() if sort_order == 'desc' else order_column
            )

        # ページネーション
        total = query.count()
        items = query.offset((page - 1) * page_size).limit(page_size).all()

        return VulnerabilityListResponse(
            items=items,
            total=total,
            page=page,
            page_size=page_size,
            total_pages=(total + page_size - 1) // page_size
        )

    def get_vulnerability_by_cve_id(self, cve_id: str) -> Vulnerability | None:
        return self.db.query(Vulnerability)\
            .filter(Vulnerability.cve_id == cve_id)\
            .first()
```

---

### src/main.py

#### 4. health_check関数（53行目）
```python
# @MOCK_TO_API: Add database connection check in Phase 5
return {
    'status': 'healthy',
    'timestamp': datetime.now(timezone.utc).isoformat()
}
```

**Phase 5での実装**:
```python
try:
    # データベース接続確認
    db_status = check_db_connection()
    return {
        'status': 'healthy',
        'database': 'connected' if db_status else 'disconnected',
        'timestamp': datetime.now(timezone.utc).isoformat()
    }
except Exception as e:
    logger.error(f'Health check failed: {e}')
    return {
        'status': 'unhealthy',
        'database': 'error',
        'error': str(e),
        'timestamp': datetime.now(timezone.utc).isoformat()
    }
```

---

## Phase 5 実装チェックリスト

### データベース統合
- [ ] `DatabaseVulnerabilityService`クラスの実装
- [ ] SQLAlchemyクエリによる検索機能
- [ ] ソート機能（重要度のカスタムソート含む）
- [ ] ページネーション機能
- [ ] エラーハンドリング（接続エラー、クエリエラー）

### JVN iPedia API統合
- [ ] `JVNFetcherService`クラスの実装
- [ ] XML応答のパース処理
- [ ] 差分取得ロジック（最終更新日時ベース）
- [ ] リトライ処理（最大3回、指数バックオフ）
- [ ] タイムアウト設定（30秒）
- [ ] レート制限対応（秒間2-3リクエスト）

### 冪等性保証
- [ ] UPSERT処理の実装（`ON CONFLICT DO UPDATE`）
- [ ] トランザクション管理
- [ ] 同一処理3回実行でデータ不整合ゼロを確認

### ヘルスチェック拡張
- [ ] データベース接続確認機能
- [ ] 5秒以内の応答時間保証
- [ ] エラー時の適切なステータスコード返却

### GitHub Actions統合
- [ ] 定期実行ワークフロー（毎日午前3時）
- [ ] 手動実行トリガー
- [ ] エラー通知設定

---

## モックサービス参照

Phase 5実装時は、以下のモックサービスの挙動を参考にしてください：

```
src/services/mock_vulnerability_service.py
  - search_vulnerabilities(): 検索・ソート・ページネーション
  - get_vulnerability_by_cve_id(): 詳細取得
```

---

**API仕様書 作成日**: 2026-01-07
**最終更新日**: 2026-01-07
**作成者**: ページ実装オーケストレーター
