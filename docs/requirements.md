# 脆弱性管理システム - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
JVN iPedia APIから脆弱性情報（直近3年分、全期間対応可能）を自動取得し、PostgreSQLに永続化する堅牢なデータ基盤。GitHub Actionsで定期実行（毎日午前3時）、簡易UIで動作確認可能、Phase 2以降の拡張を阻害しない設計。

### 1.2 成功指標

#### 定量的指標
- データ取得成功率: 99.9%以上（JVN iPedia APIに適用、リトライ3回、API完全障害のみ許容）
- 差分取得精度: 100%（新規・更新分を漏れなく取得）
- 処理時間: 1,000件を10分以内
- コードカバレッジ: 80%以上
- 冪等性: 同一処理3回実行でデータ不整合ゼロ

#### 定性的指標
- 保守性: 新規メンバーが1時間以内にコード構造を理解可能
- 拡張性: 設定変更のみで「3年分→全期間」に拡張可能
- 運用性: エラー発生時、ログから5分以内に原因特定可能
- 堅牢性: API障害時もデータ損失・DB破損なし
- 視認性: 簡易UIで取得データの正常性を即座に確認可能

---

## 2. システム全体像

### 2.1 主要機能一覧
- **脆弱性情報取得**: JVN iPedia APIから脆弱性情報を自動取得
- **データ永続化**: PostgreSQLへの安全な保存、差分取得、冪等性保証
- **定期実行**: GitHub Actionsで毎日午前3時に自動実行
- **簡易UI**: FastAPIベースの脆弱性一覧表示

### 2.2 ユーザーロールと権限
**MVPルートのため認証機能なし**
- ゲスト（全ユーザー）: 脆弱性一覧ページの閲覧

### 2.3 認証・認可要件
- 認証方式: なし（公開ページ）
- セキュリティレベル: 公開情報
- 管理機能: 不要

---

## 3. ページ詳細仕様

### 3.1 P-001: 脆弱性一覧ページ

#### 目的
取得した脆弱性情報をテーブル形式で表示し、データ取得の正常性を即座に確認可能にする。

#### 主要機能
- 脆弱性情報の一覧表示（CVE ID、タイトル、重要度、公開日、更新日、詳細表示ボタン）
- 検索機能（CVE ID + タイトルで部分一致検索）
- 詳細表示機能（モーダルウィンドウで概要、CVSS基本値、影響を受ける製品、ベンダー情報、参照情報を表示）
- ページネーション（50件/ページ）
- 基本的なソート機能（公開日、更新日、重要度）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 脆弱性一覧を取得 | ページ番号、ソート条件、検索キーワード（任意） | 脆弱性情報のリスト（50件） |
| 取得 | 脆弱性詳細を取得 | CVE ID | 脆弱性の詳細情報（モーダル表示用） |
| 検索 | CVE ID/タイトルで検索 | 検索キーワード | 検索条件に一致する脆弱性リスト |
| 表示 | 詳細表示モーダルを開く | 詳細表示ボタンクリック、CVE ID | モーダルウィンドウで詳細情報を表示 |

#### 処理フロー

**基本フロー（一覧表示）**:
1. ユーザーがページにアクセス
2. バックエンドがPostgreSQLから脆弱性データを取得
3. 一覧をテーブル形式で表示（デフォルト: 更新日降順）
4. ユーザーがソート条件やページ番号を変更可能

**検索フロー**:
1. ユーザーが検索ボックスにキーワードを入力（CVE IDまたはタイトル）
2. バックエンドがCVE ID・タイトルの両方で部分一致検索
3. 検索結果を一覧表示（ページネーション、ソート機能は維持）
4. 検索キーワードをクリアすると全件表示に戻る

**詳細表示フロー**:
1. ユーザーが一覧の「詳細表示ボタン」をクリック
2. バックエンドがCVE IDで詳細情報を取得
3. モーダルウィンドウを表示（以下の情報を含む）:
   - CVE ID、タイトル、重要度、公開日、更新日（一覧と同じ）
   - 概要（説明文）
   - CVSS基本値
   - 影響を受ける製品
   - ベンダー情報
   - 参照情報（JVN iPedia公式リンク、CWE、CVSS等）
4. モーダル外クリックまたは閉じるボタンでモーダルを閉じる

#### データ構造（概念）
```yaml
Vulnerability:
  識別子: CVE ID（一意）
  基本情報:
    - タイトル（必須）
    - 概要（必須）
    - CVSS基本値（任意）
    - 重要度（任意）
    - 公開日（必須）
    - 更新日（必須）
  詳細情報:
    - 影響を受ける製品（任意）
    - ベンダー情報（任意）
    - 参照情報（任意）
  メタ情報:
    - DB登録日時
    - DB更新日時
  関連:
    - なし（Phase 1では単一エンティティ）
```

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
Vulnerability（脆弱性情報）:
  概要: JVN iPedia APIから取得した脆弱性情報
  主要属性:
    - 識別情報: CVE ID（一意キー）、JVN ID
    - 基本情報: タイトル、概要、公開日、更新日
    - 評価情報: CVSS基本値、重要度、深刻度
    - 詳細情報: 影響を受ける製品、ベンダー情報、参照情報
  関連:
    - なし（Phase 1では単一テーブル）
```

### 4.2 エンティティ関係図
```
Vulnerability（単一エンティティ、Phase 1）

※ Phase 2以降で以下を追加予定:
  - Product（影響を受ける製品）
  - Vendor（ベンダー情報）
  - Reference（参照情報）
```

### 4.3 バリデーションルール
```yaml
CVE ID:
  - ルール: CVE-YYYY-NNNNN形式
  - 理由: 国際標準形式の遵守、一意キー

公開日・更新日:
  - ルール: ISO 8601形式（YYYY-MM-DDTHH:MM:SSZ）
  - 理由: タイムゾーン問題の回避、差分取得の精度保証

CVSS基本値:
  - ルール: 0.0〜10.0の範囲
  - 理由: CVSSスコアの仕様に準拠
```

---

## 5. 制約事項

### 外部API制限
- **JVN iPedia API**: 最大取得件数50件/リクエスト（ページネーション必須）、明示的レート制限なし（推奨: 秒間2-3リクエスト）
- **NVD API 2.0**（推奨実装）: APIキーなし（5req/30s）、APIキーあり（50req/30s）、日付範囲最大120日間
- **CISA KEV**（推奨実装）: 制限なし、ファイルダウンロード方式

### 技術的制約
- **データ取得期間**: Phase 1では直近3年分（設定変更で全期間対応可）
- **処理時間**: 1,000件を10分以内（JVN iPedia APIのレスポンス速度に依存）
- **同時実行**: GitHub Actionsは1日1回実行（並列実行なし）

---

## 5.1 セキュリティ要件

### 基本方針
本プロジェクトは **CVSS 3.1（Common Vulnerability Scoring System）** に準拠したセキュリティ要件を満たすこと。

CVSS 3.1の評価観点:
- **機密性（Confidentiality）**: 不正アクセス防止、データ暗号化
- **完全性（Integrity）**: データ改ざん防止、入力検証
- **可用性（Availability）**: DoS対策、冗長化

詳細な診断と改善は、Phase 11（本番運用診断）で @本番運用診断オーケストレーター が実施します。

---

### プロジェクト固有の必須要件

**認証機能がない場合（本プロジェクト）**:
- ✅ HTTPSの強制（本番環境）
- ✅ セキュリティヘッダー設定（本番環境）
- ✅ 入力値のサニタイゼーション（API応答のXMLパース時）
- ✅ エラーメッセージでの情報漏洩防止

**その他の一般要件**:
- ✅ APIキー・DB接続情報の環境変数管理
- ✅ ログへの機密情報出力禁止
- ✅ 外部API呼び出し時のタイムアウト設定

---

### 運用要件：可用性とヘルスチェック

**ヘルスチェックエンドポイント（全プロジェクト必須）**:
- エンドポイント: `/api/health`
- 目的: Cloud Run/Kubernetesでのliveness/readinessプローブ
- 要件: データベース接続確認、5秒以内の応答

**グレースフルシャットダウン（全プロジェクト必須）**:
- SIGTERMシグナルハンドラーの実装
- 進行中のリクエスト完了まで待機
- タイムアウト: 8秒（Cloud Runの10秒制限に対応）

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: JVN iPedia 脆弱性情報の差分取得・永続化
**トリガー**: GitHub Actions定期実行（毎日午前3時）または手動実行
**フロントエンドAPI**: なし（バックエンド単独処理）
**バックエンド内部処理**:
1. DB最終更新日時の取得（差分取得の起点決定）
2. JVN iPedia APIへのリクエスト送信（日付範囲指定、ページネーション）
3. XML応答のパース・バリデーション
4. 冪等性を保証したDB保存（UPSERT処理）
5. エラー時のリトライ処理（最大3回）
6. 処理結果のログ出力
**結果**: 取得件数、成功/失敗、エラー詳細をログに記録
**外部サービス依存**: JVN iPedia API

### 複合処理-002: 脆弱性一覧の取得（簡易UI）
**トリガー**: ユーザーが脆弱性一覧ページにアクセス
**フロントエンドAPI**: GET /api/vulnerabilities
**バックエンド内部処理**:
1. クエリパラメータの検証（ページ番号、ソート条件）
2. PostgreSQLからの脆弱性一覧取得（LIMIT/OFFSET）
3. JSON形式での応答生成
**結果**: 脆弱性一覧（50件/ページ）、総件数
**外部サービス依存**: なし

---

## 7. 技術スタック

### フロントエンド（簡易UI）
- フレームワーク: FastAPI + Jinja2
- 言語: Python 3.11+
- UIスタイル: 最小限のCSS（テーブル表示のみ）

### バックエンド
- 言語: Python 3.11+
- フレームワーク: FastAPI
- ORM: SQLAlchemy
- HTTPクライアント: httpx
- XMLパース: xml.etree.ElementTree（標準ライブラリ）

### データベース
- メインDB: PostgreSQL 15+ (Neon推奨 - https://neon.tech)
  - サーバーレスで管理不要
  - 無料枠で十分な容量
  - 自動スケーリング
  - ブランチ機能で開発/本番分離可能

### インフラ
- ホスティング: 未定（Phase 2以降で決定）
- CI/CD: GitHub Actions（定期実行、テスト自動化）

### テスト
- テストフレームワーク: pytest
- カバレッジ: pytest-cov
- 目標カバレッジ: 80%以上

### 開発環境
- コンテナ: Docker Compose（PostgreSQL、Python環境）
- バージョン管理: Git + GitHub

---

## 8. 必要な外部サービス・アカウント

### 必須サービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| JVN iPedia API | 脆弱性情報の取得（日本語） | https://jvndb.jvn.jp/apis/myjvn/ | 認証不要、無料、レート制限なし |
| PostgreSQL (Neon) | 脆弱性データの永続化 | https://neon.tech | 無料枠あり、アカウント登録必要（Phase 5で実施） |
| GitHub | リポジトリ管理、Actions実行 | https://github.com | 既存リポジトリ使用 |

### 推奨サービス（Phase 2以降で実装）
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| NVD API 2.0 | 脆弱性情報の取得（英語・最新性） | https://nvd.nist.gov/developers/request-an-api-key | 認証推奨（APIキー無料）、50req/30s |
| CISA KEV | 悪用実績のある脆弱性情報 | https://www.cisa.gov/known-exploited-vulnerabilities-catalog | 認証不要、無料、JSON/CSV |

---

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

### 拡張候補（Phase 2以降）
- NVD API統合（最新性・詳細情報の強化）
- CISA KEV統合（悪用実績フラグ、優先度判定）
- 本格的なダッシュボード（React + MUI v6）
- 高度なフィルタリング（製品名、ベンダー、重要度）
- グラフ・統計表示（月別件数、重要度分布）
- CPEマッチング（自社製品への影響評価）
- アラート機能（高重要度脆弱性の通知）
- 認証機能（ユーザー管理、権限設定）

---

**要件定義書 作成日**: 2026-01-07
**最終更新日**: 2026-01-07
**作成者**: BlueLamp 要件定義エージェント
