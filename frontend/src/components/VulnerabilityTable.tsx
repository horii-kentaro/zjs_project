import { ArrowUpDown, Eye } from 'lucide-react';
import type { Vulnerability } from '../types';
import { Badge } from './ui/Badge';
import { Button } from './ui/Button';

interface VulnerabilityTableProps {
  vulnerabilities: Vulnerability[];
  sortBy: string;
  sortOrder: 'asc' | 'desc';
  onSort: (field: string) => void;
  onViewDetail: (cveId: string) => void;
}

export function VulnerabilityTable({
  vulnerabilities,
  sortBy,
  sortOrder: _sortOrder,
  onSort,
  onViewDetail,
}: VulnerabilityTableProps) {
  const getSeverityVariant = (severity?: string): 'critical' | 'high' | 'medium' | 'low' | 'default' => {
    if (!severity) return 'default';
    const lowerSeverity = severity.toLowerCase();
    if (lowerSeverity === 'critical') return 'critical';
    if (lowerSeverity === 'high') return 'high';
    if (lowerSeverity === 'medium') return 'medium';
    if (lowerSeverity === 'low') return 'low';
    return 'default';
  };

  const formatDate = (dateString: string) => {
    const date = dateString.split('T')[0];
    return date;
  };

  const SortableHeader = ({ field, children }: { field: string; children: React.ReactNode }) => (
    <th
      className="px-6 py-3 text-left text-xs font-medium text-subtext-0 uppercase tracking-wider cursor-pointer hover:text-text transition-colors"
      onClick={() => onSort(field)}
    >
      <div className="flex items-center gap-2">
        {children}
        <ArrowUpDown size={14} className={sortBy === field ? 'text-blue' : 'text-overlay-0'} />
      </div>
    </th>
  );

  if (vulnerabilities.length === 0) {
    return (
      <div className="bg-surface-0 rounded-lg p-8 text-center">
        <p className="text-subtext-0">脆弱性が見つかりませんでした</p>
      </div>
    );
  }

  return (
    <div className="bg-surface-0 rounded-lg overflow-hidden border border-surface-1">
      <div className="overflow-x-auto scrollbar-thin">
        <table className="min-w-full divide-y divide-surface-1">
          <thead className="bg-surface-1">
            <tr>
              <SortableHeader field="cve_id">CVE ID</SortableHeader>
              <SortableHeader field="title">タイトル</SortableHeader>
              <SortableHeader field="severity">重要度</SortableHeader>
              <SortableHeader field="cvss_score">CVSS</SortableHeader>
              <SortableHeader field="published_date">公開日</SortableHeader>
              <SortableHeader field="modified_date">更新日</SortableHeader>
              <th className="px-6 py-3 text-left text-xs font-medium text-subtext-0 uppercase tracking-wider">
                操作
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-surface-1">
            {vulnerabilities.map((vuln) => (
              <tr key={vuln.cve_id} className="hover:bg-surface-1/50 transition-colors">
                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-text">
                  {vuln.cve_id}
                </td>
                <td className="px-6 py-4 text-sm text-text max-w-md truncate" title={vuln.title}>
                  {vuln.title}
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                  <Badge variant={getSeverityVariant(vuln.severity)}>
                    {vuln.severity || '不明'}
                  </Badge>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-subtext-0">
                  {vuln.cvss_score?.toFixed(1) || '-'}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-subtext-0">
                  {formatDate(vuln.published_date)}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-subtext-0">
                  {formatDate(vuln.modified_date)}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm">
                  <Button
                    size="sm"
                    variant="ghost"
                    onClick={() => onViewDetail(vuln.cve_id)}
                  >
                    <Eye size={16} />
                    詳細
                  </Button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
