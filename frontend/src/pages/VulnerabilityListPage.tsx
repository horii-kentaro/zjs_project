import { useState } from 'react';
import { Search, RefreshCw, Loader2, ChevronLeft, ChevronRight } from 'lucide-react';
import { useVulnerabilities, useFetchNow } from '../hooks/useVulnerabilities';
import { VulnerabilityTable } from '../components/VulnerabilityTable';
import { VulnerabilityDetailModal } from '../components/VulnerabilityDetailModal';
import { Button } from '../components/ui/Button';

export function VulnerabilityListPage() {
  // State管理
  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState('modified_date');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');
  const [currentPage, setCurrentPage] = useState(1);
  const [selectedCveId, setSelectedCveId] = useState<string | null>(null);
  const limit = 50;

  // データ取得
  const { data, isLoading, error } = useVulnerabilities({
    page: currentPage,
    limit,
    search: searchQuery,
    sort_by: sortBy,
    sort_order: sortOrder,
  });

  // JVN iPediaから即時取得
  const fetchNowMutation = useFetchNow();

  // ソート切り替え
  const handleSort = (field: string) => {
    if (sortBy === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(field);
      setSortOrder('desc');
    }
    setCurrentPage(1); // ソート変更時は1ページ目に戻る
  };

  // 検索実行
  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    setCurrentPage(1); // 検索時は1ページ目に戻る
  };

  // ページネーション
  const totalPages = data ? Math.ceil(data.total / limit) : 0;
  const canGoPrev = currentPage > 1;
  const canGoNext = currentPage < totalPages;

  const goToPrevPage = () => {
    if (canGoPrev) setCurrentPage(currentPage - 1);
  };

  const goToNextPage = () => {
    if (canGoNext) setCurrentPage(currentPage + 1);
  };

  // JVN iPedia取得ボタン
  const handleFetchNow = async () => {
    try {
      await fetchNowMutation.mutateAsync();
    } catch (err) {
      console.error('JVN iPedia取得エラー:', err);
    }
  };

  return (
    <div className="min-h-screen bg-base p-8">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* ヘッダー */}
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-bold text-text">脆弱性一覧</h1>
          <Button
            variant="primary"
            onClick={handleFetchNow}
            isLoading={fetchNowMutation.isPending}
            disabled={fetchNowMutation.isPending}
          >
            <RefreshCw size={16} />
            JVN iPediaから取得
          </Button>
        </div>

        {/* 取得成功メッセージ */}
        {fetchNowMutation.isSuccess && (
          <div className="bg-green/20 border border-green/30 rounded-lg p-4">
            <p className="text-green text-sm">
              ✓ 取得完了: {fetchNowMutation.data?.fetched || 0}件の脆弱性を取得しました
              {fetchNowMutation.data?.errors ? ` (エラー: ${fetchNowMutation.data.errors}件)` : ''}
            </p>
          </div>
        )}

        {/* 取得エラーメッセージ */}
        {fetchNowMutation.isError && (
          <div className="bg-red/20 border border-red/30 rounded-lg p-4">
            <p className="text-red text-sm">
              ✗ 取得エラー: {fetchNowMutation.error instanceof Error ? fetchNowMutation.error.message : '不明なエラー'}
            </p>
          </div>
        )}

        {/* 検索バー */}
        <form onSubmit={handleSearch} className="flex gap-4">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-subtext-0" size={20} />
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="CVE ID、タイトル、説明で検索..."
              className="w-full pl-10 pr-4 py-2 bg-surface-0 border border-surface-1 rounded-lg text-text placeholder:text-subtext-0 focus:outline-none focus:ring-2 focus:ring-blue"
            />
          </div>
          <Button type="submit" variant="secondary">
            検索
          </Button>
        </form>

        {/* 検索結果サマリー */}
        {data?.items && (
          <div className="flex items-center justify-between text-sm text-subtext-0">
            <p>
              全{data.total.toLocaleString()}件中 {((currentPage - 1) * limit + 1).toLocaleString()}〜
              {Math.min(currentPage * limit, data.total).toLocaleString()}件を表示
            </p>
            <p>
              ページ {currentPage} / {totalPages}
            </p>
          </div>
        )}

        {/* ローディング状態 */}
        {isLoading && (
          <div className="flex items-center justify-center py-20">
            <Loader2 className="animate-spin text-blue" size={40} />
          </div>
        )}

        {/* エラー状態 */}
        {error && (
          <div className="bg-red/20 border border-red/30 rounded-lg p-6 text-center">
            <p className="text-red">
              エラーが発生しました: {error instanceof Error ? error.message : '不明なエラー'}
            </p>
          </div>
        )}

        {/* テーブル */}
        {!isLoading && !error && data?.items && (
          <VulnerabilityTable
            vulnerabilities={data.items}
            sortBy={sortBy}
            sortOrder={sortOrder}
            onSort={handleSort}
            onViewDetail={setSelectedCveId}
          />
        )}

        {/* ページネーション */}
        {!isLoading && !error && data?.items && totalPages > 1 && (
          <div className="flex items-center justify-center gap-4">
            <Button
              variant="secondary"
              size="sm"
              onClick={goToPrevPage}
              disabled={!canGoPrev}
            >
              <ChevronLeft size={16} />
              前へ
            </Button>
            <span className="text-text">
              {currentPage} / {totalPages}
            </span>
            <Button
              variant="secondary"
              size="sm"
              onClick={goToNextPage}
              disabled={!canGoNext}
            >
              次へ
              <ChevronRight size={16} />
            </Button>
          </div>
        )}
      </div>

      {/* 詳細モーダル */}
      <VulnerabilityDetailModal
        cveId={selectedCveId}
        onClose={() => setSelectedCveId(null)}
      />
    </div>
  );
}
