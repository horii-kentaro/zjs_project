"""
SQLAlchemy model for Vulnerability table.

This module defines the Vulnerability model based on JVN iPedia API data structure.
"""

import re
from datetime import datetime
from typing import Optional

from sqlalchemy import JSON, DateTime, Float, String, Text
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy.sql import func


class Base(DeclarativeBase):
    """Base class for all SQLAlchemy models."""

    pass


class Vulnerability(Base):
    """
    Vulnerability information from JVN iPedia API.

    This model stores vulnerability data with the following key information:
    - CVE ID as the primary identifier
    - Basic information (title, description, dates)
    - CVSS scoring and severity
    - Affected products, vendor info, and references
    """

    __tablename__ = 'vulnerabilities'

    # Primary key: CVE ID (e.g., CVE-2024-0001)
    cve_id: Mapped[str] = mapped_column(String(20), primary_key=True, index=True, comment='CVE identifier')

    # Basic information
    title: Mapped[str] = mapped_column(String(500), nullable=False, comment='Vulnerability title')
    description: Mapped[str] = mapped_column(Text, nullable=False, comment='Vulnerability description')

    # CVSS scoring and severity
    cvss_score: Mapped[Optional[float]] = mapped_column(
        Float, nullable=True, comment='CVSS base score (0.0-10.0)'
    )
    severity: Mapped[Optional[str]] = mapped_column(
        String(20), nullable=True, index=True, comment='Severity level (Critical/High/Medium/Low)'
    )

    # Publication dates
    published_date: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, index=True, comment='Publication date from JVN iPedia'
    )
    modified_date: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, index=True, comment='Last modified date from JVN iPedia'
    )

    # Detailed information (stored as JSON for flexibility)
    affected_products: Mapped[Optional[dict]] = mapped_column(
        JSON, nullable=True, comment='Affected products information'
    )
    vendor_info: Mapped[Optional[dict]] = mapped_column(JSON, nullable=True, comment='Vendor information')
    references: Mapped[Optional[dict]] = mapped_column(
        JSON, nullable=True, comment='Reference links (JVN iPedia, NVD, CWE, etc.)'
    )

    # Metadata: DB timestamps
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), server_default=func.now(), nullable=False, comment='Record creation timestamp'
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
        onupdate=func.now(),
        nullable=False,
        comment='Record last update timestamp',
    )

    def __repr__(self) -> str:
        """String representation of Vulnerability model."""
        return f'<Vulnerability(cve_id={self.cve_id}, title={self.title[:50]}...)>'

    @staticmethod
    def validate_cve_id(cve_id: str) -> bool:
        """
        Validate CVE ID format.

        Args:
            cve_id: CVE identifier string

        Returns:
            True if valid, False otherwise

        Examples:
            >>> Vulnerability.validate_cve_id('CVE-2024-0001')
            True
            >>> Vulnerability.validate_cve_id('INVALID')
            False
        """
        pattern = r'^CVE-\d{4}-\d{4,}$'
        return bool(re.match(pattern, cve_id))

    @staticmethod
    def validate_cvss_score(score: Optional[float]) -> bool:
        """
        Validate CVSS score range.

        Args:
            score: CVSS base score

        Returns:
            True if valid (0.0-10.0 or None), False otherwise

        Examples:
            >>> Vulnerability.validate_cvss_score(9.8)
            True
            >>> Vulnerability.validate_cvss_score(11.0)
            False
            >>> Vulnerability.validate_cvss_score(None)
            True
        """
        if score is None:
            return True
        return 0.0 <= score <= 10.0

    @staticmethod
    def validate_severity(severity: Optional[str]) -> bool:
        """
        Validate severity level.

        Args:
            severity: Severity level string

        Returns:
            True if valid, False otherwise

        Examples:
            >>> Vulnerability.validate_severity('Critical')
            True
            >>> Vulnerability.validate_severity('Invalid')
            False
            >>> Vulnerability.validate_severity(None)
            True
        """
        if severity is None:
            return True
        valid_levels = {'Critical', 'High', 'Medium', 'Low'}
        return severity in valid_levels
