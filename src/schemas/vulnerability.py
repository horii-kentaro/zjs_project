"""
Pydantic schemas for Vulnerability API requests and responses.

This module defines Pydantic models for validation and serialization.
All schemas follow the OpenAPI specification for FastAPI integration.
"""

import re
from datetime import datetime
from typing import Optional

from pydantic import BaseModel, Field, field_validator


class VulnerabilityBase(BaseModel):
    """
    Base schema for Vulnerability with common fields.

    This schema contains fields shared across create, update, and response schemas.
    """

    title: str = Field(..., min_length=1, max_length=500, description="Vulnerability title")
    description: str = Field(..., min_length=1, description="Detailed description of the vulnerability")
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0, description="CVSS base score (0.0-10.0)")
    severity: Optional[str] = Field(None, description="Severity level (Critical/High/Medium/Low)")
    published_date: datetime = Field(..., description="Publication date from JVN iPedia")
    modified_date: datetime = Field(..., description="Last modified date from JVN iPedia")
    affected_products: Optional[dict] = Field(None, description="Affected products information (JSON)")
    vendor_info: Optional[dict] = Field(None, description="Vendor information (JSON)")
    references: Optional[dict] = Field(None, description="Reference links (JVN iPedia, NVD, CWE, etc.)")

    @field_validator("severity")
    @classmethod
    def validate_severity(cls, v: Optional[str]) -> Optional[str]:
        """Validate severity level."""
        if v is None:
            return v
        valid_levels = {"Critical", "High", "Medium", "Low"}
        if v not in valid_levels:
            raise ValueError(f"Severity must be one of {valid_levels}, got: {v}")
        return v

    model_config = {
        "json_schema_extra": {
            "example": {
                "title": "Apache HTTP Server における任意のコード実行の脆弱性",
                "description": "Apache HTTP Server 2.4.58 以前のバージョンにおいて、"
                "細工されたリクエストを処理する際にバッファオーバーフローが発生し、"
                "リモートの攻撃者により任意のコードを実行される可能性があります。",
                "cvss_score": 9.8,
                "severity": "Critical",
                "published_date": "2024-01-15T00:00:00Z",
                "modified_date": "2024-01-20T00:00:00Z",
                "affected_products": {
                    "products": ["Apache HTTP Server 2.4.0 から 2.4.58", "Red Hat Enterprise Linux 8.0 以降"]
                },
                "vendor_info": {"vendors": ["Apache Software Foundation", "Red Hat"]},
                "references": {
                    "jvn": "https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-000001.html",
                    "nvd": "https://nvd.nist.gov/vuln/detail/CVE-2024-0001",
                    "cwe": "CWE-787: Out-of-bounds Write",
                },
            }
        }
    }


class VulnerabilityCreate(VulnerabilityBase):
    """
    Schema for creating a new vulnerability record.

    Requires CVE ID and all base fields.
    """

    cve_id: str = Field(..., min_length=1, max_length=20, description="CVE identifier (e.g., CVE-2024-0001)")

    @field_validator("cve_id")
    @classmethod
    def validate_cve_id(cls, v: str) -> str:
        """Validate CVE ID format."""
        pattern = r"^CVE-\d{4}-\d{4,}$"
        if not re.match(pattern, v):
            raise ValueError(f"Invalid CVE ID format. Expected CVE-YYYY-NNNNN, got: {v}")
        return v


class VulnerabilityUpdate(BaseModel):
    """
    Schema for updating an existing vulnerability record.

    All fields are optional to support partial updates.
    """

    title: Optional[str] = Field(None, min_length=1, max_length=500, description="Vulnerability title")
    description: Optional[str] = Field(None, min_length=1, description="Detailed description")
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0, description="CVSS base score (0.0-10.0)")
    severity: Optional[str] = Field(None, description="Severity level (Critical/High/Medium/Low)")
    published_date: Optional[datetime] = Field(None, description="Publication date from JVN iPedia")
    modified_date: Optional[datetime] = Field(None, description="Last modified date from JVN iPedia")
    affected_products: Optional[dict] = Field(None, description="Affected products information (JSON)")
    vendor_info: Optional[dict] = Field(None, description="Vendor information (JSON)")
    references: Optional[dict] = Field(None, description="Reference links")

    @field_validator("severity")
    @classmethod
    def validate_severity(cls, v: Optional[str]) -> Optional[str]:
        """Validate severity level."""
        if v is None:
            return v
        valid_levels = {"Critical", "High", "Medium", "Low"}
        if v not in valid_levels:
            raise ValueError(f"Severity must be one of {valid_levels}, got: {v}")
        return v


class VulnerabilityInDB(VulnerabilityBase):
    """
    Schema for vulnerability data stored in database.

    Includes database-generated fields (created_at, updated_at).
    """

    cve_id: str = Field(..., description="CVE identifier (primary key)")
    created_at: datetime = Field(..., description="Record creation timestamp")
    updated_at: datetime = Field(..., description="Record last update timestamp")

    model_config = {"from_attributes": True}


class VulnerabilityResponse(VulnerabilityInDB):
    """
    Schema for API response.

    Same as VulnerabilityInDB, used for clarity in API documentation.
    """

    pass


class VulnerabilityListResponse(BaseModel):
    """
    Schema for paginated vulnerability list response.

    Used by GET /api/vulnerabilities endpoint.
    """

    items: list[VulnerabilityResponse] = Field(..., description="List of vulnerabilities")
    total: int = Field(..., ge=0, description="Total number of vulnerabilities")
    page: int = Field(..., ge=1, description="Current page number")
    page_size: int = Field(..., ge=1, le=100, description="Number of items per page")
    total_pages: int = Field(..., ge=0, description="Total number of pages")

    model_config = {
        "json_schema_extra": {
            "example": {
                "items": [
                    {
                        "cve_id": "CVE-2024-0001",
                        "title": "Apache HTTP Server における任意のコード実行の脆弱性",
                        "description": "Apache HTTP Server 2.4.58 以前のバージョンにおいて、脆弱性が存在します。",
                        "cvss_score": 9.8,
                        "severity": "Critical",
                        "published_date": "2024-01-15T00:00:00Z",
                        "modified_date": "2024-01-20T00:00:00Z",
                        "affected_products": {"products": ["Apache HTTP Server 2.4.0 から 2.4.58"]},
                        "vendor_info": {"vendors": ["Apache Software Foundation"]},
                        "references": {"jvn": "https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-000001.html"},
                        "created_at": "2024-01-21T03:00:00Z",
                        "updated_at": "2024-01-21T03:00:00Z",
                    }
                ],
                "total": 1500,
                "page": 1,
                "page_size": 50,
                "total_pages": 30,
            }
        }
    }


class VulnerabilitySearchParams(BaseModel):
    """
    Schema for vulnerability search query parameters.

    Used for filtering and sorting vulnerability list.
    """

    page: int = Field(1, ge=1, description="Page number (1-indexed)")
    page_size: int = Field(50, ge=1, le=100, description="Number of items per page")
    sort_by: str = Field(
        "modified_date",
        description="Sort field (published_date, modified_date, severity, cvss_score)",
    )
    sort_order: str = Field("desc", description="Sort order (asc or desc)")
    search: Optional[str] = Field(None, description="Search keyword (CVE ID or title partial match)")

    @field_validator("sort_by")
    @classmethod
    def validate_sort_by(cls, v: str) -> str:
        """Validate sort field."""
        valid_fields = {"published_date", "modified_date", "severity", "cvss_score"}
        if v not in valid_fields:
            raise ValueError(f"sort_by must be one of {valid_fields}, got: {v}")
        return v

    @field_validator("sort_order")
    @classmethod
    def validate_sort_order(cls, v: str) -> str:
        """Validate sort order."""
        valid_orders = {"asc", "desc"}
        if v not in valid_orders:
            raise ValueError(f"sort_order must be one of {valid_orders}, got: {v}")
        return v
