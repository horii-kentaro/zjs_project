"""
Mock vulnerability service for Phase 1 frontend development.

This service provides mock data for testing the vulnerability list page.
@MOCK_TO_API: Replace with actual JVN iPedia API integration in Phase 5.
"""

import logging
from datetime import datetime, timedelta
from typing import Optional

from src.schemas.vulnerability import VulnerabilityListResponse, VulnerabilityResponse

logger = logging.getLogger(__name__)


class MockVulnerabilityService:
    """
    Mock service for vulnerability data management.

    @MOCK_TO_API: This entire class will be replaced with actual database
    queries and JVN iPedia API integration in Phase 5.
    """

    def __init__(self):
        """Initialize mock service with sample data."""
        self._mock_data = self._generate_mock_data()

    def _generate_mock_data(self) -> list[dict]:
        """
        Generate mock vulnerability data.

        @MOCK_TO_API: Replace with actual database queries in Phase 5.

        Returns:
            list[dict]: List of mock vulnerability records
        """
        base_date = datetime(2024, 1, 15, 0, 0, 0)
        mock_vulnerabilities = []

        # Sample CVE data matching the mockup
        samples = [
            {
                'cve_id': 'CVE-2024-0001',
                'title': 'Apache HTTP Server における任意のコード実行の脆弱性',
                'description': 'Apache HTTP Server 2.4.58 以前のバージョンにおいて、細工されたリクエストを処理する際にバッファオーバーフローが発生し、リモートの攻撃者により任意のコードを実行される可能性があります。この脆弱性は、mod_proxy モジュールが有効化されている場合に影響を受けます。',
                'cvss_score': 9.8,
                'severity': 'Critical',
                'published_date': base_date,
                'modified_date': base_date + timedelta(days=5),
                'affected_products': {
                    'products': [
                        'Apache HTTP Server 2.4.0 から 2.4.58',
                        'Red Hat Enterprise Linux 8.0 以降',
                        'Ubuntu 20.04 LTS, 22.04 LTS',
                    ]
                },
                'vendor_info': {
                    'vendors': ['Apache Software Foundation', 'Red Hat', 'Canonical Ltd.']
                },
                'references': {
                    'jvn': 'https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-000001.html',
                    'nvd': 'https://nvd.nist.gov/vuln/detail/CVE-2024-0001',
                    'cwe': 'CWE-787: Out-of-bounds Write',
                },
            },
            {
                'cve_id': 'CVE-2024-0002',
                'title': 'WordPress におけるクロスサイトスクリプティングの脆弱性',
                'description': 'WordPress 6.4.2 以前のバージョンにおいて、特定のプラグインにクロスサイトスクリプティング（XSS）の脆弱性が存在します。',
                'cvss_score': 7.5,
                'severity': 'High',
                'published_date': base_date - timedelta(days=1),
                'modified_date': base_date + timedelta(days=4),
                'affected_products': {'products': ['WordPress 6.0 から 6.4.2']},
                'vendor_info': {'vendors': ['WordPress.org']},
                'references': {
                    'jvn': 'https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-000002.html',
                    'nvd': 'https://nvd.nist.gov/vuln/detail/CVE-2024-0002',
                    'cwe': 'CWE-79: Cross-site Scripting',
                },
            },
            {
                'cve_id': 'CVE-2024-0003',
                'title': 'Linux Kernel におけるバッファオーバーフローの脆弱性',
                'description': 'Linux Kernel 6.5.0 以前のバージョンにおいて、バッファオーバーフローの脆弱性が存在します。',
                'cvss_score': 5.5,
                'severity': 'Medium',
                'published_date': base_date - timedelta(days=2),
                'modified_date': base_date + timedelta(days=3),
                'affected_products': {'products': ['Linux Kernel 5.0 から 6.5.0']},
                'vendor_info': {'vendors': ['Linux Foundation']},
                'references': {
                    'jvn': 'https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-000003.html',
                    'nvd': 'https://nvd.nist.gov/vuln/detail/CVE-2024-0003',
                    'cwe': 'CWE-120: Buffer Overflow',
                },
            },
            {
                'cve_id': 'CVE-2024-0004',
                'title': 'MySQL における情報漏洩の脆弱性',
                'description': 'MySQL 8.0.35 以前のバージョンにおいて、情報漏洩の脆弱性が存在します。',
                'cvss_score': 3.1,
                'severity': 'Low',
                'published_date': base_date - timedelta(days=3),
                'modified_date': base_date + timedelta(days=2),
                'affected_products': {'products': ['MySQL 8.0.0 から 8.0.35']},
                'vendor_info': {'vendors': ['Oracle Corporation']},
                'references': {
                    'jvn': 'https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-000004.html',
                    'nvd': 'https://nvd.nist.gov/vuln/detail/CVE-2024-0004',
                    'cwe': 'CWE-200: Information Exposure',
                },
            },
            {
                'cve_id': 'CVE-2024-0005',
                'title': 'OpenSSL における暗号化の脆弱性',
                'description': 'OpenSSL 3.1.4 以前のバージョンにおいて、暗号化処理の脆弱性が存在します。',
                'cvss_score': 7.8,
                'severity': 'High',
                'published_date': base_date - timedelta(days=4),
                'modified_date': base_date + timedelta(days=1),
                'affected_products': {'products': ['OpenSSL 3.0.0 から 3.1.4']},
                'vendor_info': {'vendors': ['OpenSSL Software Foundation']},
                'references': {
                    'jvn': 'https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-000005.html',
                    'nvd': 'https://nvd.nist.gov/vuln/detail/CVE-2024-0005',
                    'cwe': 'CWE-327: Use of a Broken or Risky Cryptographic Algorithm',
                },
            },
        ]

        # Generate additional mock data (total 100 records for pagination testing)
        for i, sample in enumerate(samples):
            mock_vulnerabilities.append(
                {
                    **sample,
                    'created_at': datetime.now() - timedelta(days=10),
                    'updated_at': datetime.now() - timedelta(days=5),
                }
            )

        # Generate additional dummy records
        for i in range(6, 101):
            severity_map = {0: 'Critical', 1: 'High', 2: 'Medium', 3: 'Low'}
            cvss_map = {0: 9.5, 1: 7.5, 2: 5.5, 3: 3.0}
            severity_idx = i % 4
            mock_vulnerabilities.append(
                {
                    'cve_id': f'CVE-2024-{i:04d}',
                    'title': f'サンプル脆弱性 {i}',
                    'description': f'これはサンプルの脆弱性説明です。CVE-2024-{i:04d}',
                    'cvss_score': cvss_map[severity_idx],
                    'severity': severity_map[severity_idx],
                    'published_date': base_date - timedelta(days=i),
                    'modified_date': base_date - timedelta(days=i - 5),
                    'affected_products': {'products': [f'Product {i}']},
                    'vendor_info': {'vendors': [f'Vendor {i}']},
                    'references': {
                        'jvn': f'https://jvndb.jvn.jp/ja/contents/2024/JVNDB-2024-{i:06d}.html',
                        'nvd': f'https://nvd.nist.gov/vuln/detail/CVE-2024-{i:04d}',
                        'cwe': 'CWE-000: Sample Weakness',
                    },
                    'created_at': datetime.now() - timedelta(days=10),
                    'updated_at': datetime.now() - timedelta(days=5),
                }
            )

        logger.info(f'Generated {len(mock_vulnerabilities)} mock vulnerability records')
        return mock_vulnerabilities

    def search_vulnerabilities(
        self,
        page: int = 1,
        page_size: int = 50,
        sort_by: str = 'modified_date',
        sort_order: str = 'desc',
        search: Optional[str] = None,
    ) -> VulnerabilityListResponse:
        """
        Search and filter vulnerability data.

        @MOCK_TO_API: Replace with actual database queries using SQLAlchemy in Phase 5.

        Args:
            page: Page number (1-indexed)
            page_size: Number of items per page
            sort_by: Sort field (published_date, modified_date, severity, cvss_score)
            sort_order: Sort order (asc or desc)
            search: Search keyword (CVE ID or title partial match)

        Returns:
            VulnerabilityListResponse: Paginated vulnerability list
        """
        logger.info(
            f'Searching vulnerabilities: page={page}, page_size={page_size}, '
            f'sort_by={sort_by}, sort_order={sort_order}, search={search}'
        )

        # Filter by search keyword
        filtered_data = self._mock_data
        if search:
            search_lower = search.lower()
            filtered_data = [
                item
                for item in filtered_data
                if search_lower in item['cve_id'].lower() or search_lower in item['title'].lower()
            ]
            logger.info(f'Filtered {len(filtered_data)} records matching search: {search}')

        # Sort data
        sorted_data = self._sort_vulnerabilities(filtered_data, sort_by, sort_order)

        # Pagination
        total = len(sorted_data)
        total_pages = (total + page_size - 1) // page_size
        start_idx = (page - 1) * page_size
        end_idx = start_idx + page_size
        paginated_data = sorted_data[start_idx:end_idx]

        # Convert to VulnerabilityResponse objects
        items = [VulnerabilityResponse(**item) for item in paginated_data]

        logger.info(
            f'Returning page {page}/{total_pages} with {len(items)} items (total: {total})'
        )

        return VulnerabilityListResponse(
            items=items,
            total=total,
            page=page,
            page_size=page_size,
            total_pages=total_pages,
        )

    def get_vulnerability_by_cve_id(self, cve_id: str) -> Optional[VulnerabilityResponse]:
        """
        Get vulnerability by CVE ID.

        @MOCK_TO_API: Replace with actual database query in Phase 5.

        Args:
            cve_id: CVE identifier

        Returns:
            Optional[VulnerabilityResponse]: Vulnerability data or None if not found
        """
        logger.info(f'Fetching vulnerability: {cve_id}')

        for item in self._mock_data:
            if item['cve_id'] == cve_id:
                logger.info(f'Found vulnerability: {cve_id}')
                return VulnerabilityResponse(**item)

        logger.warning(f'Vulnerability not found: {cve_id}')
        return None

    def _sort_vulnerabilities(
        self, data: list[dict], sort_by: str, sort_order: str
    ) -> list[dict]:
        """
        Sort vulnerability data.

        Args:
            data: List of vulnerability records
            sort_by: Sort field
            sort_order: Sort order (asc or desc)

        Returns:
            list[dict]: Sorted list
        """
        # Map severity to numeric values for sorting
        severity_map = {'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1, None: 0}

        def sort_key(item):
            if sort_by == 'severity':
                return severity_map.get(item.get('severity'), 0)
            return item.get(sort_by, '')

        reverse = sort_order == 'desc'
        return sorted(data, key=sort_key, reverse=reverse)


# Global service instance
mock_service = MockVulnerabilityService()
