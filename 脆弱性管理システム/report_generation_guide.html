<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¬ã‚¤ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f6f8fa;
            color: #24292f;
            line-height: 1.6;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #24292f;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #57606a;
            margin-bottom: 30px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #24292f;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8250df;
        }
        .section h2.phase1 { border-bottom-color: #2da44e; }
        .section h2.phase2 { border-bottom-color: #0969da; }
        .section h2.phase3 { border-bottom-color: #bf8700; }
        .section h3 {
            color: #24292f;
            font-size: 16px;
            margin: 24px 0 12px;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #d0d7de;
        }
        th {
            background: #f6f8fa;
            font-weight: 600;
        }
        
        /* å›³è§£ */
        .diagram {
            background: #f6f8fa;
            border-radius: 8px;
            padding: 24px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        /* ãƒ•ã‚§ãƒ¼ã‚ºã‚«ãƒ¼ãƒ‰ */
        .phase-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .phase-card {
            border: 2px solid #d0d7de;
            border-radius: 8px;
            overflow: hidden;
            text-align: center;
        }
        .phase-card-header {
            padding: 12px;
            color: white;
            font-weight: bold;
        }
        .phase-card-header.phase1 { background: #2da44e; }
        .phase-card-header.phase2 { background: #0969da; }
        .phase-card-header.phase3 { background: #bf8700; }
        .phase-card-header.phase4 { background: #8250df; }
        .phase-card-body {
            padding: 16px;
        }
        .phase-card-body p {
            font-size: 13px;
            color: #57606a;
            margin-bottom: 8px;
        }
        .phase-card-sprint {
            font-size: 12px;
            color: #57606a;
            margin-top: 8px;
        }
        
        /* ãƒã‚¤ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ */
        .point-box {
            background: #ddf4ff;
            border: 1px solid #54aeff;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .point-box h4 {
            color: #0969da;
            margin-bottom: 8px;
        }
        .point-box ul {
            margin-left: 20px;
        }
        .point-box li {
            margin: 4px 0;
        }
        
        .callout {
            background: #fff8c5;
            border: 1px solid #d4a72c;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 12px 0;
            font-size: 14px;
        }
        .callout::before {
            content: "ğŸ’¡";
            margin-right: 8px;
        }
        
        .recommend-box {
            background: #dafbe1;
            border: 1px solid #2da44e;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .recommend-box h4 {
            color: #1a7f37;
            margin-bottom: 8px;
        }
        
        .warning-box {
            background: #ffebe9;
            border: 1px solid #ff8182;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .warning-box h4 {
            color: #cf222e;
            margin-bottom: 8px;
        }
        
        /* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ */
        .code-block {
            background: #24292f;
            color: #e6edf3;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 16px 0;
            line-height: 1.5;
        }
        .code-block .comment {
            color: #8b949e;
        }
        .code-block .keyword {
            color: #ff7b72;
        }
        .code-block .string {
            color: #a5d6ff;
        }
        .code-block .function {
            color: #d2a8ff;
        }
        .code-block .number {
            color: #79c0ff;
        }
        .code-block .class {
            color: #7ee787;
        }
        .code-block .decorator {
            color: #ffa657;
        }
        
        code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        
        /* ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .report-preview {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            overflow: hidden;
            margin: 16px 0;
        }
        .report-header {
            background: #24292f;
            color: white;
            padding: 16px 20px;
        }
        .report-header h3 {
            color: white;
            margin: 0;
            font-size: 18px;
        }
        .report-header p {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 4px;
        }
        .report-body {
            padding: 20px;
        }
        .report-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-card {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
        }
        .summary-card.critical { background: #ffebe9; }
        .summary-card.high { background: #fff8c5; }
        .summary-card.medium { background: #ddf4ff; }
        .summary-card.low { background: #dafbe1; }
        .summary-card .number {
            font-size: 32px;
            font-weight: bold;
        }
        .summary-card.critical .number { color: #cf222e; }
        .summary-card.high .number { color: #9a6700; }
        .summary-card.medium .number { color: #0969da; }
        .summary-card.low .number { color: #1a7f37; }
        .summary-card .label {
            font-size: 12px;
            color: #57606a;
        }
        
        /* ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ— */
        .roadmap {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        .roadmap::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 10%;
            right: 10%;
            height: 4px;
            background: #d0d7de;
            z-index: 0;
        }
        .roadmap-item {
            text-align: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }
        .roadmap-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
            color: white;
        }
        .roadmap-icon.phase1 { background: #2da44e; }
        .roadmap-icon.phase2 { background: #0969da; }
        .roadmap-icon.phase3 { background: #bf8700; }
        .roadmap-icon.phase4 { background: #8250df; }
        .roadmap-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .roadmap-desc {
            font-size: 12px;
            color: #57606a;
        }
        
        /* å‡ºåŠ›å½¢å¼ãƒãƒƒã‚¸ */
        .format-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 4px;
        }
        .format-html { background: #ddf4ff; color: #0969da; }
        .format-csv { background: #dafbe1; color: #1a7f37; }
        .format-pdf { background: #ffebe9; color: #cf222e; }
        .format-excel { background: #fff8c5; color: #9a6700; }

        @media (max-width: 768px) {
            .report-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .roadmap {
                flex-direction: column;
                gap: 20px;
            }
            .roadmap::before {
                display: none;
            }
        }

        @media print {
            body { background: white; }
            .section { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¬ã‚¤ãƒ‰</h1>
        <p class="subtitle">æ®µéšçš„ãªå®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆHTML â†’ CSV â†’ PDF â†’ ã‚°ãƒ©ãƒ•ï¼‰</p>

        <!-- æ¦‚è¦ -->
        <div class="section">
            <h2>ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã®å…¨ä½“åƒ</h2>
            
            <p style="margin-bottom: 20px;">
                ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½ã¯<strong>æ®µéšçš„ã«æ‹¡å¼µ</strong>ã—ã¦ã„ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒç¾å®Ÿçš„ã§ã™ã€‚
                ã¾ãšã‚³ã‚¢æ©Ÿèƒ½ï¼ˆãƒ‡ãƒ¼ã‚¿é›†è¨ˆ + HTML/CSVå‡ºåŠ›ï¼‰ã‚’ä½œã‚Šã€å¾Œã‹ã‚‰PDFã€ã‚°ãƒ©ãƒ•ãªã©ã‚’è¿½åŠ ã—ã¾ã™ã€‚
            </p>
            
            <h3>å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</h3>
            <div class="roadmap">
                <div class="roadmap-item">
                    <div class="roadmap-icon phase1">ğŸ“„</div>
                    <div class="roadmap-title">Phase 1</div>
                    <div class="roadmap-desc">HTML + CSV<br>Sprint 4</div>
                </div>
                <div class="roadmap-item">
                    <div class="roadmap-icon phase2">ğŸ“‘</div>
                    <div class="roadmap-title">Phase 2</div>
                    <div class="roadmap-desc">PDFå‡ºåŠ›<br>Sprint 4-5</div>
                </div>
                <div class="roadmap-item">
                    <div class="roadmap-icon phase3">ğŸ“ˆ</div>
                    <div class="roadmap-title">Phase 3</div>
                    <div class="roadmap-desc">ã‚°ãƒ©ãƒ•ç”Ÿæˆ<br>å°†æ¥æ‹¡å¼µ</div>
                </div>
                <div class="roadmap-item">
                    <div class="roadmap-icon phase4">ğŸ“Š</div>
                    <div class="roadmap-title">Phase 4</div>
                    <div class="roadmap-desc">Excelé€£æº<br>å°†æ¥æ‹¡å¼µ</div>
                </div>
            </div>
            
            <h3>å„Phaseã®æ¦‚è¦</h3>
            <div class="phase-cards">
                <div class="phase-card">
                    <div class="phase-card-header phase1">Phase 1ï¼šã‚³ã‚¢æ©Ÿèƒ½</div>
                    <div class="phase-card-body">
                        <p><strong>HTML + CSVå‡ºåŠ›</strong></p>
                        <p>ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã‚¯ã‚¨ãƒª<br>HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ<br>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</p>
                        <div class="phase-card-sprint">ğŸ¯ Sprint 4ï¼ˆå¿…é ˆï¼‰</div>
                    </div>
                </div>
                <div class="phase-card">
                    <div class="phase-card-header phase2">Phase 2ï¼šPDFå‡ºåŠ›</div>
                    <div class="phase-card-body">
                        <p><strong>PDFå¤‰æ›</strong></p>
                        <p>WeasyPrintä½¿ç”¨<br>ãƒ¡ãƒ¼ãƒ«æ·»ä»˜ç”¨<br>å°åˆ·å¯¾å¿œ</p>
                        <div class="phase-card-sprint">ğŸ¯ Sprint 4-5</div>
                    </div>
                </div>
                <div class="phase-card">
                    <div class="phase-card-header phase3">Phase 3ï¼šã‚°ãƒ©ãƒ•</div>
                    <div class="phase-card-body">
                        <p><strong>è¦–è¦šåŒ–</strong></p>
                        <p>ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•<br>å††ã‚°ãƒ©ãƒ•<br>æ£’ã‚°ãƒ©ãƒ•</p>
                        <div class="phase-card-sprint">ğŸ“… å°†æ¥æ‹¡å¼µ</div>
                    </div>
                </div>
                <div class="phase-card">
                    <div class="phase-card-header phase4">Phase 4ï¼šExcel</div>
                    <div class="phase-card-body">
                        <p><strong>Excelé€£æº</strong></p>
                        <p>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡ºåŠ›<br>è¤‡æ•°ã‚·ãƒ¼ãƒˆ<br>æ•°å¼åŸ‹ã‚è¾¼ã¿</p>
                        <div class="phase-card-sprint">ğŸ“… å°†æ¥æ‹¡å¼µ</div>
                    </div>
                </div>
            </div>
            
            <h3>å„ªå…ˆé †ä½</h3>
            <table>
                <tr>
                    <th>å„ªå…ˆåº¦</th>
                    <th>æ©Ÿèƒ½</th>
                    <th>å‡ºåŠ›å½¢å¼</th>
                    <th>ç†ç”±</th>
                </tr>
                <tr>
                    <td><span style="color: #cf222e; font-weight: bold;">é«˜</span></td>
                    <td>HTMLã‚µãƒãƒªãƒ¼</td>
                    <td><span class="format-badge format-html">HTML</span></td>
                    <td>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å³è¡¨ç¤ºå¯èƒ½</td>
                </tr>
                <tr>
                    <td><span style="color: #cf222e; font-weight: bold;">é«˜</span></td>
                    <td>CSVå‡ºåŠ›</td>
                    <td><span class="format-badge format-csv">CSV</span></td>
                    <td>Excelã§è‡ªç”±ã«åŠ å·¥ã§ãã‚‹</td>
                </tr>
                <tr>
                    <td><span style="color: #bf8700; font-weight: bold;">ä¸­</span></td>
                    <td>PDFå‡ºåŠ›</td>
                    <td><span class="format-badge format-pdf">PDF</span></td>
                    <td>æ­£å¼ãƒ¬ãƒãƒ¼ãƒˆã€ãƒ¡ãƒ¼ãƒ«æ·»ä»˜</td>
                </tr>
                <tr>
                    <td><span style="color: #57606a;">ä½</span></td>
                    <td>ã‚°ãƒ©ãƒ•ç”Ÿæˆ</td>
                    <td><span class="format-badge format-html">HTML</span><span class="format-badge format-pdf">PDF</span></td>
                    <td>è¦‹æ „ãˆã¯è‰¯ã„ãŒå¿…é ˆã§ã¯ãªã„</td>
                </tr>
                <tr>
                    <td><span style="color: #57606a;">ä½</span></td>
                    <td>Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</td>
                    <td><span class="format-badge format-excel">XLSX</span></td>
                    <td>è¦ä»¶ãŒå›ºã¾ã£ã¦ã‹ã‚‰</td>
                </tr>
            </table>
        </div>

        <!-- ãƒ¬ãƒãƒ¼ãƒˆã®ç¨®é¡ -->
        <div class="section">
            <h2>ğŸ“‘ ãƒ¬ãƒãƒ¼ãƒˆã®ç¨®é¡</h2>
            
            <table>
                <tr>
                    <th style="width: 20%;">ãƒ¬ãƒãƒ¼ãƒˆå</th>
                    <th style="width: 15%;">é »åº¦</th>
                    <th>å†…å®¹</th>
                    <th style="width: 20%;">ä¸»ãªç”¨é€”</th>
                </tr>
                <tr>
                    <td><strong>æ—¥æ¬¡ã‚µãƒãƒªãƒ¼</strong></td>
                    <td>æ¯æ—¥</td>
                    <td>æ–°è¦æ¤œå‡ºæ•°ã€è§£æ¶ˆæ•°ã€æœªå¯¾å¿œæ•°ã€Criticalä»¶æ•°</td>
                    <td>æœä¼šã§ã®ç¢ºèª</td>
                </tr>
                <tr>
                    <td><strong>é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</strong></td>
                    <td>æ¯é€±</td>
                    <td>é€±é–“æ¨ç§»ã€å¯¾å¿œçŠ¶æ³ã€ãƒˆãƒƒãƒ—10è„†å¼±æ€§</td>
                    <td>é€±æ¬¡å ±å‘Šã€ç®¡ç†è€…å‘ã‘</td>
                </tr>
                <tr>
                    <td><strong>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</strong></td>
                    <td>æ¯æœˆ</td>
                    <td>æœˆé–“çµ±è¨ˆã€ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã€KPIé”æˆçŠ¶æ³</td>
                    <td>çµŒå–¶å ±å‘Šã€ç›£æŸ»å¯¾å¿œ</td>
                </tr>
                <tr>
                    <td><strong>è³‡ç”£åˆ¥ãƒ¬ãƒãƒ¼ãƒˆ</strong></td>
                    <td>éšæ™‚</td>
                    <td>ç‰¹å®šè³‡ç”£ã®è„†å¼±æ€§ä¸€è¦§ã€å¯¾å¿œå±¥æ­´</td>
                    <td>æ‹…å½“è€…å‘ã‘ã€æ”¹å–„è¨ˆç”»</td>
                </tr>
                <tr>
                    <td><strong>CVEè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</strong></td>
                    <td>éšæ™‚</td>
                    <td>ç‰¹å®šCVEã®å½±éŸ¿ç¯„å›²ã€è©²å½“è³‡ç”£ä¸€è¦§</td>
                    <td>ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ</td>
                </tr>
            </table>
        </div>

        <!-- Phase 1: ã‚³ã‚¢æ©Ÿèƒ½ -->
        <div class="section">
            <h2 class="phase1">ğŸŸ¢ Phase 1ï¼šã‚³ã‚¢æ©Ÿèƒ½ï¼ˆHTML + CSVï¼‰</h2>
            
            <p style="margin-bottom: 16px;">
                ã¾ãšæœ€å°é™ã®ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã¨ã‚·ãƒ³ãƒ—ãƒ«ãªå‡ºåŠ›ãŒä¸­å¿ƒã§ã™ã€‚
            </p>
            
            <h3>ãƒ¬ãƒãƒ¼ãƒˆåŸºåº•ã‚¯ãƒ©ã‚¹ã®è¨­è¨ˆ</h3>
            <div class="code-block">
<span class="comment"># report_generator.py</span>
<span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta
<span class="keyword">from</span> typing <span class="keyword">import</span> Dict, List, Any
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass
<span class="keyword">import</span> csv
<span class="keyword">import</span> io

<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">ReportData</span>:
    <span class="string">"""ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ """</span>
    title: str
    generated_at: datetime
    period_start: datetime
    period_end: datetime
    summary: Dict[str, Any]
    details: List[Dict[str, Any]]


<span class="keyword">class</span> <span class="class">ReportGenerator</span>(ABC):
    <span class="string">"""ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã®åŸºåº•ã‚¯ãƒ©ã‚¹"""</span>
    
    <span class="keyword">def</span> <span class="function">__init__</span>(self, db_session):
        self.db = db_session
    
    <span class="decorator">@abstractmethod</span>
    <span class="keyword">def</span> <span class="function">collect_data</span>(self, start_date: datetime, end_date: datetime) -> ReportData:
        <span class="string">"""ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ï¼ˆã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…ï¼‰"""</span>
        <span class="keyword">pass</span>
    
    <span class="keyword">def</span> <span class="function">to_html</span>(self, data: ReportData) -> str:
        <span class="string">"""HTMLå½¢å¼ã§å‡ºåŠ›"""</span>
        <span class="keyword">raise</span> NotImplementedError
    
    <span class="keyword">def</span> <span class="function">to_csv</span>(self, data: ReportData) -> str:
        <span class="string">"""CSVå½¢å¼ã§å‡ºåŠ›"""</span>
        <span class="keyword">raise</span> NotImplementedError
    
    <span class="keyword">def</span> <span class="function">to_pdf</span>(self, data: ReportData) -> bytes:
        <span class="string">"""PDFå½¢å¼ã§å‡ºåŠ›ï¼ˆPhase 2ã§å®Ÿè£…ï¼‰"""</span>
        <span class="keyword">raise</span> NotImplementedError
            </div>
            
            <h3>ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã®å®Ÿè£…</h3>
            <div class="code-block">
<span class="comment"># summary_report.py</span>
<span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template

<span class="keyword">class</span> <span class="class">SummaryReportGenerator</span>(ReportGenerator):
    <span class="string">"""ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"""</span>
    
    <span class="keyword">def</span> <span class="function">collect_data</span>(self, start_date: datetime, end_date: datetime) -> ReportData:
        <span class="string">"""ãƒ‡ãƒ¼ã‚¿ã‚’åé›†"""</span>
        
        <span class="comment"># é‡è¦åº¦åˆ¥ã®é›†è¨ˆ</span>
        severity_counts = self.db.execute(<span class="string">"""
            SELECT 
                severity,
                COUNT(*) as count
            FROM vulnerability_matches vm
            JOIN vulnerabilities v ON vm.vulnerability_id = v.id
            WHERE vm.detected_at BETWEEN :start AND :end
              AND vm.status = 'OPEN'
            GROUP BY severity
        """</span>, {<span class="string">"start"</span>: start_date, <span class="string">"end"</span>: end_date}).fetchall()
        
        <span class="comment"># ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®é›†è¨ˆ</span>
        status_counts = self.db.execute(<span class="string">"""
            SELECT 
                status,
                COUNT(*) as count
            FROM vulnerability_matches
            WHERE detected_at BETWEEN :start AND :end
            GROUP BY status
        """</span>, {<span class="string">"start"</span>: start_date, <span class="string">"end"</span>: end_date}).fetchall()
        
        <span class="comment"># è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆCritical/Highï¼‰</span>
        critical_vulns = self.db.execute(<span class="string">"""
            SELECT 
                v.cve_id,
                v.title,
                v.cvss_score,
                v.severity,
                a.hostname,
                a.environment,
                vm.detected_at,
                vm.status
            FROM vulnerability_matches vm
            JOIN vulnerabilities v ON vm.vulnerability_id = v.id
            JOIN assets a ON vm.asset_id = a.id
            WHERE vm.detected_at BETWEEN :start AND :end
              AND v.severity IN ('Critical', 'High')
            ORDER BY v.cvss_score DESC
            LIMIT 50
        """</span>, {<span class="string">"start"</span>: start_date, <span class="string">"end"</span>: end_date}).fetchall()
        
        <span class="keyword">return</span> ReportData(
            title=<span class="string">"è„†å¼±æ€§ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ"</span>,
            generated_at=datetime.now(),
            period_start=start_date,
            period_end=end_date,
            summary={
                <span class="string">"severity_counts"</span>: {row.severity: row.count <span class="keyword">for</span> row <span class="keyword">in</span> severity_counts},
                <span class="string">"status_counts"</span>: {row.status: row.count <span class="keyword">for</span> row <span class="keyword">in</span> status_counts},
                <span class="string">"total"</span>: sum(row.count <span class="keyword">for</span> row <span class="keyword">in</span> severity_counts)
            },
            details=[dict(row) <span class="keyword">for</span> row <span class="keyword">in</span> critical_vulns]
        )
            </div>
            
            <h3>HTMLå‡ºåŠ›ã®å®Ÿè£…</h3>
            <div class="code-block">
<span class="comment"># HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
SUMMARY_HTML_TEMPLATE = <span class="string">"""
&lt;!DOCTYPE html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;{{ data.title }}&lt;/title&gt;
    &lt;style&gt;
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #24292f; color: white; padding: 20px; }
        .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin: 20px 0; }
        .card { text-align: center; padding: 20px; border-radius: 8px; }
        .card.critical { background: #ffebe9; }
        .card.high { background: #fff8c5; }
        .card.medium { background: #ddf4ff; }
        .card.low { background: #dafbe1; }
        .card .number { font-size: 36px; font-weight: bold; }
        .card.critical .number { color: #cf222e; }
        .card.high .number { color: #9a6700; }
        .card.medium .number { color: #0969da; }
        .card.low .number { color: #1a7f37; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #f6f8fa; }
        .severity-critical { color: #cf222e; font-weight: bold; }
        .severity-high { color: #9a6700; font-weight: bold; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="header"&gt;
        &lt;h1&gt;{{ data.title }}&lt;/h1&gt;
        &lt;p&gt;æœŸé–“: {{ data.period_start.strftime('%Y/%m/%d') }} - {{ data.period_end.strftime('%Y/%m/%d') }}&lt;/p&gt;
        &lt;p&gt;ç”Ÿæˆæ—¥æ™‚: {{ data.generated_at.strftime('%Y/%m/%d %H:%M') }}&lt;/p&gt;
    &lt;/div&gt;
    
    &lt;h2&gt;ã‚µãƒãƒªãƒ¼&lt;/h2&gt;
    &lt;div class="summary-cards"&gt;
        &lt;div class="card critical"&gt;
            &lt;div class="number"&gt;{{ data.summary.severity_counts.get('Critical', 0) }}&lt;/div&gt;
            &lt;div&gt;Critical&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="card high"&gt;
            &lt;div class="number"&gt;{{ data.summary.severity_counts.get('High', 0) }}&lt;/div&gt;
            &lt;div&gt;High&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="card medium"&gt;
            &lt;div class="number"&gt;{{ data.summary.severity_counts.get('Medium', 0) }}&lt;/div&gt;
            &lt;div&gt;Medium&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="card low"&gt;
            &lt;div class="number"&gt;{{ data.summary.severity_counts.get('Low', 0) }}&lt;/div&gt;
            &lt;div&gt;Low&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;h2&gt;Critical/High è„†å¼±æ€§ä¸€è¦§&lt;/h2&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;CVE ID&lt;/th&gt;
            &lt;th&gt;ã‚¿ã‚¤ãƒˆãƒ«&lt;/th&gt;
            &lt;th&gt;CVSS&lt;/th&gt;
            &lt;th&gt;é‡è¦åº¦&lt;/th&gt;
            &lt;th&gt;å¯¾è±¡è³‡ç”£&lt;/th&gt;
            &lt;th&gt;ç’°å¢ƒ&lt;/th&gt;
            &lt;th&gt;ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹&lt;/th&gt;
        &lt;/tr&gt;
        {% for item in data.details %}
        &lt;tr&gt;
            &lt;td&gt;{{ item.cve_id }}&lt;/td&gt;
            &lt;td&gt;{{ item.title[:50] }}...&lt;/td&gt;
            &lt;td&gt;{{ item.cvss_score }}&lt;/td&gt;
            &lt;td class="severity-{{ item.severity|lower }}"&gt;{{ item.severity }}&lt;/td&gt;
            &lt;td&gt;{{ item.hostname }}&lt;/td&gt;
            &lt;td&gt;{{ item.environment }}&lt;/td&gt;
            &lt;td&gt;{{ item.status }}&lt;/td&gt;
        &lt;/tr&gt;
        {% endfor %}
    &lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
"""</span>

<span class="keyword">class</span> <span class="class">SummaryReportGenerator</span>(ReportGenerator):
    <span class="comment"># ... collect_data ã¯ä¸Šè¨˜ã®é€šã‚Š ...</span>
    
    <span class="keyword">def</span> <span class="function">to_html</span>(self, data: ReportData) -> str:
        <span class="string">"""HTMLå½¢å¼ã§å‡ºåŠ›"""</span>
        template = Template(SUMMARY_HTML_TEMPLATE)
        <span class="keyword">return</span> template.render(data=data)
            </div>
            
            <h3>CSVå‡ºåŠ›ã®å®Ÿè£…</h3>
            <div class="code-block">
<span class="keyword">def</span> <span class="function">to_csv</span>(self, data: ReportData) -> str:
    <span class="string">"""CSVå½¢å¼ã§å‡ºåŠ›"""</span>
    
    output = io.StringIO()
    writer = csv.writer(output)
    
    <span class="comment"># ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±</span>
    writer.writerow([<span class="string">"ãƒ¬ãƒãƒ¼ãƒˆå"</span>, data.title])
    writer.writerow([<span class="string">"æœŸé–“"</span>, f<span class="string">"{data.period_start} - {data.period_end}"</span>])
    writer.writerow([<span class="string">"ç”Ÿæˆæ—¥æ™‚"</span>, data.generated_at.strftime(<span class="string">"%Y/%m/%d %H:%M"</span>)])
    writer.writerow([])
    
    <span class="comment"># ã‚µãƒãƒªãƒ¼</span>
    writer.writerow([<span class="string">"ã€ã‚µãƒãƒªãƒ¼ã€‘"</span>])
    writer.writerow([<span class="string">"é‡è¦åº¦"</span>, <span class="string">"ä»¶æ•°"</span>])
    <span class="keyword">for</span> severity, count <span class="keyword">in</span> data.summary[<span class="string">"severity_counts"</span>].items():
        writer.writerow([severity, count])
    writer.writerow([])
    
    <span class="comment"># è©³ç´°ãƒ‡ãƒ¼ã‚¿</span>
    writer.writerow([<span class="string">"ã€è©³ç´°ä¸€è¦§ã€‘"</span>])
    writer.writerow([<span class="string">"CVE ID"</span>, <span class="string">"ã‚¿ã‚¤ãƒˆãƒ«"</span>, <span class="string">"CVSS"</span>, <span class="string">"é‡è¦åº¦"</span>, <span class="string">"å¯¾è±¡è³‡ç”£"</span>, <span class="string">"ç’°å¢ƒ"</span>, <span class="string">"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"</span>])
    <span class="keyword">for</span> item <span class="keyword">in</span> data.details:
        writer.writerow([
            item[<span class="string">"cve_id"</span>],
            item[<span class="string">"title"</span>],
            item[<span class="string">"cvss_score"</span>],
            item[<span class="string">"severity"</span>],
            item[<span class="string">"hostname"</span>],
            item[<span class="string">"environment"</span>],
            item[<span class="string">"status"</span>]
        ])
    
    <span class="keyword">return</span> output.getvalue()
            </div>
            
            <h3>ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆHTMLï¼‰</h3>
            <div class="report-preview">
                <div class="report-header">
                    <h3>è„†å¼±æ€§ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                    <p>æœŸé–“: 2024/12/01 - 2024/12/07 | ç”Ÿæˆæ—¥æ™‚: 2024/12/08 09:00</p>
                </div>
                <div class="report-body">
                    <h4 style="margin-bottom: 16px;">ã‚µãƒãƒªãƒ¼</h4>
                    <div class="report-summary">
                        <div class="summary-card critical">
                            <div class="number">3</div>
                            <div class="label">Critical</div>
                        </div>
                        <div class="summary-card high">
                            <div class="number">12</div>
                            <div class="label">High</div>
                        </div>
                        <div class="summary-card medium">
                            <div class="number">28</div>
                            <div class="label">Medium</div>
                        </div>
                        <div class="summary-card low">
                            <div class="number">45</div>
                            <div class="label">Low</div>
                        </div>
                    </div>
                    <h4 style="margin: 20px 0 16px;">Critical/High è„†å¼±æ€§ä¸€è¦§</h4>
                    <table style="font-size: 13px;">
                        <tr>
                            <th>CVE ID</th>
                            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th>CVSS</th>
                            <th>å¯¾è±¡è³‡ç”£</th>
                            <th>ç’°å¢ƒ</th>
                        </tr>
                        <tr>
                            <td>CVE-2024-1234</td>
                            <td>Apache HTTP Server ã®é‡å¤§ãªè„†å¼±æ€§</td>
                            <td>9.8</td>
                            <td>web-server-01</td>
                            <td>æœ¬ç•ª</td>
                        </tr>
                        <tr>
                            <td>CVE-2024-5678</td>
                            <td>OpenSSL ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼</td>
                            <td>8.1</td>
                            <td>api-server-01</td>
                            <td>æœ¬ç•ª</td>
                        </tr>
                        <tr>
                            <td>CVE-2024-9012</td>
                            <td>PostgreSQL èªè¨¼ãƒã‚¤ãƒ‘ã‚¹</td>
                            <td>7.5</td>
                            <td>db-server-01</td>
                            <td>æœ¬ç•ª</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Phase 2: PDFå‡ºåŠ› -->
        <div class="section">
            <h2 class="phase2">ğŸ”µ Phase 2ï¼šPDFå‡ºåŠ›</h2>
            
            <p style="margin-bottom: 16px;">
                HTMLã‚’PDFã«å¤‰æ›ã—ã¾ã™ã€‚<strong>WeasyPrint</strong>ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒæœ€ã‚‚ç°¡å˜ã§ã™ã€‚
            </p>
            
            <h3>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¯”è¼ƒ</h3>
            <table>
                <tr>
                    <th style="width: 20%;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</th>
                    <th>ç‰¹å¾´</th>
                    <th style="width: 20%;">æ¨å¥¨åº¦</th>
                </tr>
                <tr>
                    <td><strong>WeasyPrint</strong></td>
                    <td>HTML/CSSã‚’ãã®ã¾ã¾PDFã«å¤‰æ›ã€‚æ—¥æœ¬èªå¯¾å¿œâ—</td>
                    <td><span style="color: #2da44e; font-weight: bold;">â­ æ¨å¥¨</span></td>
                </tr>
                <tr>
                    <td><strong>ReportLab</strong></td>
                    <td>Pythonã‚³ãƒ¼ãƒ‰ã§ç›´æ¥PDFç”Ÿæˆã€‚ç´°ã‹ã„åˆ¶å¾¡å¯èƒ½</td>
                    <td>è¤‡é›‘ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå‘ã‘</td>
                </tr>
                <tr>
                    <td><strong>pdfkit</strong></td>
                    <td>wkhtmltopdfã®ãƒ©ãƒƒãƒ‘ãƒ¼ã€‚å¤–éƒ¨ä¾å­˜ã‚ã‚Š</td>
                    <td>ç’°å¢ƒæ§‹ç¯‰ãŒå¿…è¦</td>
                </tr>
            </table>
            
            <h3>WeasyPrintã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
            <div class="code-block">
<span class="comment"># ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>
pip install weasyprint

<span class="comment"># æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆï¼ˆUbuntu/Debianï¼‰</span>
apt-get install fonts-noto-cjk
            </div>
            
            <h3>PDFå‡ºåŠ›ã®å®Ÿè£…</h3>
            <div class="code-block">
<span class="comment"># pdf_generator.py</span>
<span class="keyword">from</span> weasyprint <span class="keyword">import</span> HTML, CSS
<span class="keyword">from</span> weasyprint.text.fonts <span class="keyword">import</span> FontConfiguration

<span class="keyword">class</span> <span class="class">SummaryReportGenerator</span>(ReportGenerator):
    <span class="comment"># ... collect_data, to_html, to_csv ã¯ä¸Šè¨˜ã®é€šã‚Š ...</span>
    
    <span class="keyword">def</span> <span class="function">to_pdf</span>(self, data: ReportData) -> bytes:
        <span class="string">"""PDFå½¢å¼ã§å‡ºåŠ›"""</span>
        
        <span class="comment"># HTMLã‚’ç”Ÿæˆ</span>
        html_content = self.to_html(data)
        
        <span class="comment"># PDFç”¨ã®è¿½åŠ CSSï¼ˆå°åˆ·å‘ã‘èª¿æ•´ï¼‰</span>
        pdf_css = CSS(string=<span class="string">"""
            @page {
                size: A4;
                margin: 2cm;
                @bottom-center {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 10px;
                }
            }
            body {
                font-family: 'Noto Sans CJK JP', sans-serif;
            }
            table {
                page-break-inside: avoid;
            }
        """</span>)
        
        <span class="comment"># ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š</span>
        font_config = FontConfiguration()
        
        <span class="comment"># PDFç”Ÿæˆ</span>
        html = HTML(string=html_content)
        pdf_bytes = html.write_pdf(
            stylesheets=[pdf_css],
            font_config=font_config
        )
        
        <span class="keyword">return</span> pdf_bytes
    
    <span class="keyword">def</span> <span class="function">save_pdf</span>(self, data: ReportData, filepath: str):
        <span class="string">"""PDFã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""</span>
        pdf_bytes = self.to_pdf(data)
        <span class="keyword">with</span> open(filepath, <span class="string">"wb"</span>) <span class="keyword">as</span> f:
            f.write(pdf_bytes)
            </div>
            
            <h3>ä½¿ç”¨ä¾‹</h3>
            <div class="code-block">
<span class="comment"># ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã¨å‡ºåŠ›</span>
generator = SummaryReportGenerator(db_session)

<span class="comment"># ãƒ‡ãƒ¼ã‚¿åé›†</span>
data = generator.collect_data(
    start_date=datetime(<span class="number">2024</span>, <span class="number">12</span>, <span class="number">1</span>),
    end_date=datetime(<span class="number">2024</span>, <span class="number">12</span>, <span class="number">7</span>)
)

<span class="comment"># HTMLå‡ºåŠ›ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºç”¨ï¼‰</span>
html = generator.to_html(data)

<span class="comment"># CSVå‡ºåŠ›ï¼ˆExcelã§é–‹ã‘ã‚‹ï¼‰</span>
csv_content = generator.to_csv(data)
<span class="keyword">with</span> open(<span class="string">"report.csv"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8-sig"</span>) <span class="keyword">as</span> f:
    f.write(csv_content)

<span class="comment"># PDFå‡ºåŠ›ï¼ˆãƒ¡ãƒ¼ãƒ«æ·»ä»˜ç”¨ï¼‰</span>
generator.save_pdf(data, <span class="string">"report.pdf"</span>)
            </div>
            
            <div class="callout">
                CSVå‡ºåŠ›æ™‚ã¯ <code>utf-8-sig</code> ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Excelã§æ–‡å­—åŒ–ã‘ã—ã¾ã›ã‚“ã€‚
            </div>
        </div>

        <!-- Phase 3: ã‚°ãƒ©ãƒ•ç”Ÿæˆ -->
        <div class="section">
            <h2 class="phase3">ğŸŸ¡ Phase 3ï¼šã‚°ãƒ©ãƒ•ç”Ÿæˆï¼ˆå°†æ¥æ‹¡å¼µï¼‰</h2>
            
            <p style="margin-bottom: 16px;">
                è¦–è¦šçš„ãªãƒ¬ãƒãƒ¼ãƒˆãŒå¿…è¦ã«ãªã£ãŸã‚‰ã€ã‚°ãƒ©ãƒ•ç”Ÿæˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚
            </p>
            
            <h3>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é¸æŠè‚¢</h3>
            <table>
                <tr>
                    <th style="width: 20%;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</th>
                    <th>ç‰¹å¾´</th>
                    <th style="width: 25%;">ç”¨é€”</th>
                </tr>
                <tr>
                    <td><strong>matplotlib</strong></td>
                    <td>å®šç•ªã®ã‚°ãƒ©ãƒ•ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚é™çš„ãªç”»åƒå‡ºåŠ›</td>
                    <td>PDFåŸ‹ã‚è¾¼ã¿ç”¨</td>
                </tr>
                <tr>
                    <td><strong>Plotly</strong></td>
                    <td>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚°ãƒ©ãƒ•ã€‚HTMLå‡ºåŠ›</td>
                    <td>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨</td>
                </tr>
                <tr>
                    <td><strong>Chart.js</strong></td>
                    <td>JavaScriptã€‚HTMLã«åŸ‹ã‚è¾¼ã¿</td>
                    <td>Webãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨</td>
                </tr>
            </table>
            
            <h3>matplotlib ã§ã®ã‚°ãƒ©ãƒ•ç”Ÿæˆä¾‹</h3>
            <div class="code-block">
<span class="comment"># chart_generator.py</span>
<span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt
<span class="keyword">import</span> matplotlib
<span class="keyword">import</span> io
<span class="keyword">import</span> base64

<span class="comment"># æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š</span>
matplotlib.rcParams[<span class="string">'font.family'</span>] = <span class="string">'Noto Sans CJK JP'</span>

<span class="keyword">class</span> <span class="class">ChartGenerator</span>:
    <span class="string">"""ã‚°ãƒ©ãƒ•ç”Ÿæˆã‚¯ãƒ©ã‚¹"""</span>
    
    <span class="keyword">def</span> <span class="function">severity_pie_chart</span>(self, severity_counts: dict) -> str:
        <span class="string">"""é‡è¦åº¦åˆ¥ã®å††ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆï¼ˆBase64ç”»åƒï¼‰"""</span>
        
        labels = list(severity_counts.keys())
        sizes = list(severity_counts.values())
        colors = [<span class="string">'#cf222e'</span>, <span class="string">'#bf8700'</span>, <span class="string">'#0969da'</span>, <span class="string">'#2da44e'</span>]
        
        fig, ax = plt.subplots(figsize=(<span class="number">6</span>, <span class="number">6</span>))
        ax.pie(sizes, labels=labels, colors=colors, autopct=<span class="string">'%1.1f%%'</span>)
        ax.set_title(<span class="string">'é‡è¦åº¦åˆ¥ è„†å¼±æ€§åˆ†å¸ƒ'</span>)
        
        <span class="comment"># Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰</span>
        buf = io.BytesIO()
        plt.savefig(buf, format=<span class="string">'png'</span>, bbox_inches=<span class="string">'tight'</span>)
        buf.seek(<span class="number">0</span>)
        img_base64 = base64.b64encode(buf.read()).decode(<span class="string">'utf-8'</span>)
        plt.close()
        
        <span class="keyword">return</span> f<span class="string">'data:image/png;base64,{img_base64}'</span>
    
    <span class="keyword">def</span> <span class="function">trend_line_chart</span>(self, dates: list, counts: list) -> str:
        <span class="string">"""ãƒˆãƒ¬ãƒ³ãƒ‰ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ"""</span>
        
        fig, ax = plt.subplots(figsize=(<span class="number">10</span>, <span class="number">4</span>))
        ax.plot(dates, counts, marker=<span class="string">'o'</span>, color=<span class="string">'#0969da'</span>)
        ax.set_title(<span class="string">'è„†å¼±æ€§æ¤œå‡ºæ•°ã®æ¨ç§»'</span>)
        ax.set_xlabel(<span class="string">'æ—¥ä»˜'</span>)
        ax.set_ylabel(<span class="string">'æ¤œå‡ºæ•°'</span>)
        ax.grid(<span class="keyword">True</span>, alpha=<span class="number">0.3</span>)
        
        <span class="comment"># Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰</span>
        buf = io.BytesIO()
        plt.savefig(buf, format=<span class="string">'png'</span>, bbox_inches=<span class="string">'tight'</span>)
        buf.seek(<span class="number">0</span>)
        img_base64 = base64.b64encode(buf.read()).decode(<span class="string">'utf-8'</span>)
        plt.close()
        
        <span class="keyword">return</span> f<span class="string">'data:image/png;base64,{img_base64}'</span>
            </div>
            
            <h3>HTMLã¸ã®ã‚°ãƒ©ãƒ•åŸ‹ã‚è¾¼ã¿</h3>
            <div class="code-block">
<span class="comment"># HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã‚°ãƒ©ãƒ•ã‚’åŸ‹ã‚è¾¼ã¿</span>
REPORT_WITH_CHART_TEMPLATE = <span class="string">"""
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;...&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;é‡è¦åº¦åˆ†å¸ƒ&lt;/h2&gt;
    &lt;img src="{{ pie_chart_base64 }}" alt="é‡è¦åº¦åˆ¥åˆ†å¸ƒ"&gt;
    
    &lt;h2&gt;æ¤œå‡ºæ•°ãƒˆãƒ¬ãƒ³ãƒ‰&lt;/h2&gt;
    &lt;img src="{{ trend_chart_base64 }}" alt="ãƒˆãƒ¬ãƒ³ãƒ‰"&gt;
&lt;/body&gt;
&lt;/html&gt;
"""</span>

<span class="keyword">def</span> <span class="function">to_html_with_charts</span>(self, data: ReportData) -> str:
    chart_gen = ChartGenerator()
    
    pie_chart = chart_gen.severity_pie_chart(data.summary[<span class="string">"severity_counts"</span>])
    trend_chart = chart_gen.trend_line_chart(data.trend_dates, data.trend_counts)
    
    template = Template(REPORT_WITH_CHART_TEMPLATE)
    <span class="keyword">return</span> template.render(
        data=data,
        pie_chart_base64=pie_chart,
        trend_chart_base64=trend_chart
    )
            </div>
        </div>

        <!-- é€±æ¬¡/æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ -->
        <div class="section">
            <h2>ğŸ“… é€±æ¬¡/æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®å®Ÿè£…</h2>
            
            <h3>é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®è¿½åŠ ãƒ‡ãƒ¼ã‚¿</h3>
            <div class="code-block">
<span class="keyword">class</span> <span class="class">WeeklyReportGenerator</span>(ReportGenerator):
    <span class="string">"""é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"""</span>
    
    <span class="keyword">def</span> <span class="function">collect_data</span>(self, start_date: datetime, end_date: datetime) -> ReportData:
        <span class="comment"># åŸºæœ¬ã®ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿</span>
        summary = self._get_summary(start_date, end_date)
        
        <span class="comment"># é€±é–“ã®æ—¥åˆ¥æ¨ç§»</span>
        daily_trend = self.db.execute(<span class="string">"""
            SELECT 
                DATE(detected_at) as date,
                COUNT(*) as count
            FROM vulnerability_matches
            WHERE detected_at BETWEEN :start AND :end
            GROUP BY DATE(detected_at)
            ORDER BY date
        """</span>, {<span class="string">"start"</span>: start_date, <span class="string">"end"</span>: end_date}).fetchall()
        
        <span class="comment"># å‰é€±ã¨ã®æ¯”è¼ƒ</span>
        prev_start = start_date - timedelta(days=<span class="number">7</span>)
        prev_end = start_date
        prev_summary = self._get_summary(prev_start, prev_end)
        
        <span class="comment"># å¯¾å¿œå®Œäº†ç‡</span>
        resolution_rate = self._get_resolution_rate(start_date, end_date)
        
        <span class="comment"># è³‡ç”£åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
        top_assets = self.db.execute(<span class="string">"""
            SELECT 
                a.hostname,
                a.environment,
                COUNT(*) as vuln_count
            FROM vulnerability_matches vm
            JOIN assets a ON vm.asset_id = a.id
            WHERE vm.detected_at BETWEEN :start AND :end
              AND vm.status = 'OPEN'
            GROUP BY a.id
            ORDER BY vuln_count DESC
            LIMIT 10
        """</span>, {<span class="string">"start"</span>: start_date, <span class="string">"end"</span>: end_date}).fetchall()
        
        <span class="keyword">return</span> ReportData(
            title=<span class="string">"é€±æ¬¡è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆ"</span>,
            generated_at=datetime.now(),
            period_start=start_date,
            period_end=end_date,
            summary={
                <span class="string">"current"</span>: summary,
                <span class="string">"previous"</span>: prev_summary,
                <span class="string">"daily_trend"</span>: daily_trend,
                <span class="string">"resolution_rate"</span>: resolution_rate,
                <span class="string">"top_assets"</span>: top_assets
            },
            details=self._get_critical_vulns(start_date, end_date)
        )
            </div>
            
            <h3>å‰é€±æ¯”è¼ƒã®è¡¨ç¤ºä¾‹</h3>
            <div class="code-block">
<span class="comment"># å‰é€±æ¯”è¼ƒã‚’HTMLã«å«ã‚ã‚‹</span>
COMPARISON_HTML = <span class="string">"""
&lt;div class="comparison"&gt;
    &lt;h3&gt;å‰é€±ã¨ã®æ¯”è¼ƒ&lt;/h3&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;é …ç›®&lt;/th&gt;
            &lt;th&gt;ä»Šé€±&lt;/th&gt;
            &lt;th&gt;å‰é€±&lt;/th&gt;
            &lt;th&gt;å¢—æ¸›&lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;æ–°è¦æ¤œå‡º&lt;/td&gt;
            &lt;td&gt;{{ current.new_count }}&lt;/td&gt;
            &lt;td&gt;{{ previous.new_count }}&lt;/td&gt;
            &lt;td class="{{ 'increase' if diff &gt; 0 else 'decrease' }}"&gt;
                {{ '+' if diff &gt; 0 else '' }}{{ diff }}
            &lt;/td&gt;
        &lt;/tr&gt;
        ...
    &lt;/table&gt;
&lt;/div&gt;
"""</span>
            </div>
        </div>

        <!-- APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ -->
        <div class="section">
            <h2>ğŸ”Œ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</h2>
            
            <p style="margin-bottom: 16px;">
                ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚„ãƒ¡ãƒ¼ãƒ«é…ä¿¡ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ã®APIã‚’ç”¨æ„ã—ã¾ã™ã€‚
            </p>
            
            <div class="code-block">
<span class="comment"># api/reports.py (FastAPI)</span>
<span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter, Query
<span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse, StreamingResponse
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta
<span class="keyword">import</span> io

router = APIRouter(prefix=<span class="string">"/api/reports"</span>, tags=[<span class="string">"reports"</span>])

<span class="decorator">@router.get</span>(<span class="string">"/summary"</span>, response_class=HTMLResponse)
<span class="keyword">async</span> <span class="keyword">def</span> <span class="function">get_summary_html</span>(
    start_date: datetime = Query(<span class="keyword">None</span>),
    end_date: datetime = Query(<span class="keyword">None</span>)
):
    <span class="string">"""ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆï¼ˆHTMLï¼‰ã‚’å–å¾—"""</span>
    
    <span class="keyword">if not</span> end_date:
        end_date = datetime.now()
    <span class="keyword">if not</span> start_date:
        start_date = end_date - timedelta(days=<span class="number">7</span>)
    
    generator = SummaryReportGenerator(db_session)
    data = generator.collect_data(start_date, end_date)
    html = generator.to_html(data)
    
    <span class="keyword">return</span> HTMLResponse(content=html)


<span class="decorator">@router.get</span>(<span class="string">"/summary/csv"</span>)
<span class="keyword">async</span> <span class="keyword">def</span> <span class="function">get_summary_csv</span>(
    start_date: datetime = Query(<span class="keyword">None</span>),
    end_date: datetime = Query(<span class="keyword">None</span>)
):
    <span class="string">"""ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""</span>
    
    <span class="keyword">if not</span> end_date:
        end_date = datetime.now()
    <span class="keyword">if not</span> start_date:
        start_date = end_date - timedelta(days=<span class="number">7</span>)
    
    generator = SummaryReportGenerator(db_session)
    data = generator.collect_data(start_date, end_date)
    csv_content = generator.to_csv(data)
    
    <span class="comment"># ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹</span>
    <span class="keyword">return</span> StreamingResponse(
        io.StringIO(csv_content),
        media_type=<span class="string">"text/csv"</span>,
        headers={
            <span class="string">"Content-Disposition"</span>: f<span class="string">"attachment; filename=report_{end_date.strftime('%Y%m%d')}.csv"</span>
        }
    )


<span class="decorator">@router.get</span>(<span class="string">"/summary/pdf"</span>)
<span class="keyword">async</span> <span class="keyword">def</span> <span class="function">get_summary_pdf</span>(
    start_date: datetime = Query(<span class="keyword">None</span>),
    end_date: datetime = Query(<span class="keyword">None</span>)
):
    <span class="string">"""ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆï¼ˆPDFï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"""</span>
    
    <span class="keyword">if not</span> end_date:
        end_date = datetime.now()
    <span class="keyword">if not</span> start_date:
        start_date = end_date - timedelta(days=<span class="number">7</span>)
    
    generator = SummaryReportGenerator(db_session)
    data = generator.collect_data(start_date, end_date)
    pdf_bytes = generator.to_pdf(data)
    
    <span class="keyword">return</span> StreamingResponse(
        io.BytesIO(pdf_bytes),
        media_type=<span class="string">"application/pdf"</span>,
        headers={
            <span class="string">"Content-Disposition"</span>: f<span class="string">"attachment; filename=report_{end_date.strftime('%Y%m%d')}.pdf"</span>
        }
    )
            </div>
        </div>

        <!-- å®šæœŸé…ä¿¡ -->
        <div class="section">
            <h2>â° å®šæœŸãƒ¬ãƒãƒ¼ãƒˆé…ä¿¡</h2>
            
            <p style="margin-bottom: 16px;">
                é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã—ã¦ã€å®šæœŸçš„ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’é…ä¿¡ã—ã¾ã™ã€‚
            </p>
            
            <div class="code-block">
<span class="comment"># scheduled_reports.py</span>
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta

<span class="keyword">def</span> <span class="function">send_weekly_report</span>():
    <span class="string">"""é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡"""</span>
    
    <span class="comment"># æœŸé–“è¨­å®šï¼ˆå…ˆé€±ã®æœˆæ›œã€œæ—¥æ›œï¼‰</span>
    today = datetime.now()
    end_date = today - timedelta(days=today.weekday())  <span class="comment"># ä»Šé€±æœˆæ›œ</span>
    start_date = end_date - timedelta(days=<span class="number">7</span>)           <span class="comment"># å…ˆé€±æœˆæ›œ</span>
    
    <span class="comment"># ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</span>
    generator = WeeklyReportGenerator(db_session)
    data = generator.collect_data(start_date, end_date)
    
    <span class="comment"># PDFç”Ÿæˆ</span>
    pdf_bytes = generator.to_pdf(data)
    pdf_path = f<span class="string">"/tmp/weekly_report_{end_date.strftime('%Y%m%d')}.pdf"</span>
    <span class="keyword">with</span> open(pdf_path, <span class="string">"wb"</span>) <span class="keyword">as</span> f:
        f.write(pdf_bytes)
    
    <span class="comment"># ãƒ¡ãƒ¼ãƒ«é€ä¿¡</span>
    email_notifier.send_email(
        to=[<span class="string">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f18294928483988588dc8594909cb19489909c819d94df929e9c">[email&#160;protected]</a>"</span>, <span class="string">"<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fa979b949b9d9f8889ba9f829b978a969fd4999597">[email&#160;protected]</a>"</span>],
        subject=f<span class="string">"ã€é€±æ¬¡ã€‘è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆ {start_date.strftime('%m/%d')}ã€œ{end_date.strftime('%m/%d')}"</span>,
        body_html=generator.to_html(data),
        attachments=[pdf_path]
    )
    
    <span class="comment"># Teamsã«ã‚‚ã‚µãƒãƒªãƒ¼ã‚’æŠ•ç¨¿</span>
    teams_notifier.send_weekly_summary({
        <span class="string">"period"</span>: f<span class="string">"{start_date.strftime('%m/%d')}ã€œ{end_date.strftime('%m/%d')}"</span>,
        <span class="string">"new_count"</span>: data.summary[<span class="string">"current"</span>][<span class="string">"new_count"</span>],
        <span class="string">"resolved_count"</span>: data.summary[<span class="string">"current"</span>][<span class="string">"resolved_count"</span>],
        <span class="string">"critical_count"</span>: data.summary[<span class="string">"current"</span>][<span class="string">"critical_count"</span>]
    })


<span class="comment"># cronè¨­å®š: æ¯é€±æœˆæ›œ 09:00</span>
<span class="comment"># 0 9 * * 1 python -c "from scheduled_reports import send_weekly_report; send_weekly_report()"</span>
            </div>
        </div>

        <!-- æ‹…å½“ã‚¿ã‚¹ã‚¯ -->
        <div class="section">
            <h2>ğŸ“‹ æ‹…å½“Eã®ã‚¿ã‚¹ã‚¯</h2>
            
            <table>
                <tr>
                    <th>Sprint</th>
                    <th>ã‚¿ã‚¹ã‚¯</th>
                    <th>è©³ç´°</th>
                </tr>
                <tr>
                    <td><strong>Sprint 4</strong></td>
                    <td>Phase 1ï¼šã‚³ã‚¢æ©Ÿèƒ½</td>
                    <td>
                        ãƒ»ReportGeneratoråŸºåº•ã‚¯ãƒ©ã‚¹ä½œæˆ<br>
                        ãƒ»ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã®é›†è¨ˆã‚¯ã‚¨ãƒª<br>
                        ãƒ»HTMLå‡ºåŠ›ï¼ˆJinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰<br>
                        ãƒ»CSVå‡ºåŠ›
                    </td>
                </tr>
                <tr>
                    <td><strong>Sprint 4-5</strong></td>
                    <td>Phase 2ï¼šPDFå‡ºåŠ›</td>
                    <td>
                        ãƒ»WeasyPrintå°å…¥<br>
                        ãƒ»å°åˆ·ç”¨CSSèª¿æ•´<br>
                        ãƒ»æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
                    </td>
                </tr>
                <tr>
                    <td><strong>Sprint 5</strong></td>
                    <td>APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</td>
                    <td>
                        ãƒ»/api/reports/* ã®å®Ÿè£…<br>
                        ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®å‘¼ã³å‡ºã—<br>
                        ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
                    </td>
                </tr>
                <tr>
                    <td><strong>Sprint 5</strong></td>
                    <td>å®šæœŸé…ä¿¡é€£æº</td>
                    <td>
                        ãƒ»æ‹…å½“Dã®é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æº<br>
                        ãƒ»é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
                    </td>
                </tr>
                <tr>
                    <td><strong>å°†æ¥</strong></td>
                    <td>Phase 3-4ï¼šæ‹¡å¼µæ©Ÿèƒ½</td>
                    <td>
                        ãƒ»ã‚°ãƒ©ãƒ•ç”Ÿæˆï¼ˆmatplotlibï¼‰<br>
                        ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ<br>
                        ãƒ»Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡ºåŠ›
                    </td>
                </tr>
            </table>
        </div>

        <!-- ã¾ã¨ã‚ -->
        <div class="section">
            <h2>ğŸ“ ã¾ã¨ã‚</h2>
            
            <table>
                <tr>
                    <th style="width: 15%;">Phase</th>
                    <th style="width: 20%;">æ©Ÿèƒ½</th>
                    <th>å‡ºåŠ›å½¢å¼</th>
                    <th style="width: 15%;">æ™‚æœŸ</th>
                </tr>
                <tr>
                    <td><strong>Phase 1</strong></td>
                    <td>ã‚³ã‚¢æ©Ÿèƒ½</td>
                    <td><span class="format-badge format-html">HTML</span><span class="format-badge format-csv">CSV</span></td>
                    <td>Sprint 4</td>
                </tr>
                <tr>
                    <td><strong>Phase 2</strong></td>
                    <td>PDFå‡ºåŠ›</td>
                    <td><span class="format-badge format-pdf">PDF</span></td>
                    <td>Sprint 4-5</td>
                </tr>
                <tr>
                    <td><strong>Phase 3</strong></td>
                    <td>ã‚°ãƒ©ãƒ•ç”Ÿæˆ</td>
                    <td><span class="format-badge format-html">HTML</span><span class="format-badge format-pdf">PDF</span></td>
                    <td>å°†æ¥æ‹¡å¼µ</td>
                </tr>
                <tr>
                    <td><strong>Phase 4</strong></td>
                    <td>Excelé€£æº</td>
                    <td><span class="format-badge format-excel">XLSX</span></td>
                    <td>å°†æ¥æ‹¡å¼µ</td>
                </tr>
            </table>
            
            <div class="recommend-box">
                <h4>âœ… æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ãƒ¡ãƒªãƒƒãƒˆ</h4>
                <ul>
                    <li><strong>æ—©æœŸã«ä¾¡å€¤æä¾›</strong>ï¼šPhase 1ã ã‘ã§ååˆ†ä½¿ãˆã‚‹ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½</li>
                    <li><strong>ãƒªã‚¹ã‚¯ä½æ¸›</strong>ï¼šå°ã•ãä½œã£ã¦ç¢ºèªã—ãªãŒã‚‰é€²ã‚ã‚‹</li>
                    <li><strong>æŸ”è»Ÿãªæ‹¡å¼µ</strong>ï¼šè¦ä»¶ãŒå›ºã¾ã£ã¦ã‹ã‚‰ã‚°ãƒ©ãƒ•ç­‰ã‚’è¿½åŠ </li>
                    <li><strong>å·¥æ•°ã®æœ€é©åŒ–</strong>ï¼šå¿…è¦ãªã‚‚ã®ã‹ã‚‰å„ªå…ˆçš„ã«å®Ÿè£…</li>
                </ul>
            </div>
        </div>

        <!-- å‚è€ƒãƒªãƒ³ã‚¯ -->
        <div class="section">
            <h2>ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯</h2>
            
            <table>
                <tr>
                    <th style="width: 25%;">ãƒªã‚½ãƒ¼ã‚¹</th>
                    <th>URL</th>
                </tr>
                <tr>
                    <td><strong>WeasyPrint</strong></td>
                    <td><a href="https://weasyprint.org/" target="_blank">https://weasyprint.org/</a></td>
                </tr>
                <tr>
                    <td><strong>Jinja2 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</strong></td>
                    <td><a href="https://jinja.palletsprojects.com/" target="_blank">https://jinja.palletsprojects.com/</a></td>
                </tr>
                <tr>
                    <td><strong>matplotlib</strong></td>
                    <td><a href="https://matplotlib.org/" target="_blank">https://matplotlib.org/</a></td>
                </tr>
                <tr>
                    <td><strong>Plotly</strong></td>
                    <td><a href="https://plotly.com/python/" target="_blank">https://plotly.com/python/</a></td>
                </tr>
            